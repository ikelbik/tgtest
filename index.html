<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Space WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .subtitle {
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .wallet-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .wallet-info {
            display: none;
            margin-top: 15px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            padding: 10px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-section {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-item {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .token-symbol {
            font-weight: bold;
            font-size: 18px;
        }

        .balance-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-window {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .error-window.show {
            transform: translateX(0);
        }

        .error-window.success {
            background: #28a745;
        }

        .action-group {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .action-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .recipient-info {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .network-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            text-align: center;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">GGCoin Sender</div>
            <div class="subtitle">Отправка GGCoin токенов</div>
        </div>

        <div class="wallet-section">
            <div id="ton-connect-button"></div>
            
            <div class="wallet-info" id="wallet-info">
                <div class="wallet-address" id="wallet-address">Адрес: ...</div>
                <button class="btn btn-secondary" id="refresh-balance">Обновить баланс</button>
                <button class="btn btn-danger" id="disconnect-wallet">Отключить кошелек</button>
            </div>
        </div>

        <div class="balance-section" id="balance-section" style="display: none;">
            <div class="action-title">Баланс GGCoin</div>
            <div id="balance-display">
                <div class="loading">Загрузка баланса...</div>
            </div>
        </div>

        <div class="action-group" id="send-section" style="display: none;">
            <div class="action-title">Отправить GGCoin</div>
            <div class="input-group">
                <label class="input-label">Адрес получателя:</label>
                <div class="recipient-info">UQBak6BF62bcdFXplIcoOtrh45eVpECUI9ZdymxixK501w-h</div>
            </div>
            <div class="input-group">
                <label class="input-label">Сумма (GGCoin):</label>
                <input type="number" class="input-field" id="send-amount" placeholder="1" step="0.0001" min="0.0001">
            </div>
            <button class="btn btn-primary" id="send-transaction">Отправить</button>
        </div>

        <div class="action-group" id="debug-section" style="display: none;">
            <div class="action-title">Отладочная информация</div>
            <div id="debug-output" style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; color: #333; border: 1px solid #ddd;"></div>
        </div>

        <div class="network-info">
            <span class="status-indicator" id="status-indicator"></span>
            <span id="network-status">Инициализация...</span>
        </div>
    </div>

    <div class="error-window" id="error-window">
        <div class="error-title">Сообщение</div>
        <div class="error-message" id="error-message"></div>
    </div>

    <script>
        // Константы
        const GGCOIN_TOKEN_ADDRESS_RAW = '0:7f82a882da388deecaa53806c44c375f697a09fd86d93e9c0e1832749b222b0b';
        const GGCOIN_TOKEN_ADDRESS_USER_FRIENDLY = 'EQB_gqiC2jiN7sqlOAbETDdfaXoJ_YbZPpwOGDJ0myIrC2n4';
        const RECIPIENT_ADDRESS = 'UQBak6BF62bcdFXplIcoOtrh45eVpECUI9ZdymxixK501w-h';

        // Переменные состояния
        let tonConnectUI = null;
        let walletAddress = null;
        let ggcoinBalance = 0;
        let jettonWalletAddress = null;
        let isConnected = false;

        // Элементы DOM
        const walletInfo = document.getElementById('wallet-info');
        const walletAddressElement = document.getElementById('wallet-address');
        const balanceSection = document.getElementById('balance-section');
        const balanceDisplay = document.getElementById('balance-display');
        const sendSection = document.getElementById('send-section');
        const debugSection = document.getElementById('debug-section');
        const debugOutput = document.getElementById('debug-output');
        const refreshBalanceBtn = document.getElementById('refresh-balance');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet');
        const sendTransactionBtn = document.getElementById('send-transaction');
        const sendAmountInput = document.getElementById('send-amount');
        const statusIndicator = document.getElementById('status-indicator');
        const networkStatus = document.getElementById('network-status');
        const errorWindow = document.getElementById('error-window');

        // Инициализация Telegram WebApp
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // Функция добавления отладочной информации
        function addDebugLog(message) {
            console.log(message);
            if (debugOutput) {
                const timestamp = new Date().toLocaleTimeString();
                debugOutput.textContent += `[${timestamp}] ${message}\n`;
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
        }

        // Функция добавления отладочной информации
        function addDebugLog(message) {
            console.log(message);
            if (debugOutput) {
                const timestamp = new Date().toLocaleTimeString();
                debugOutput.textContent += `[${timestamp}] ${message}\n`;
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
        }

        // Функция конвертации адреса в RAW формат для API
        function convertToRawAddress(address) {
            try {
                // Если уже в RAW формате, возвращаем как есть
                if (address.includes(':')) {
                    return address;
                }
                
                // Если в user-friendly формате (EQ/UQ), конвертируем в RAW
                if (address.startsWith('EQ') || address.startsWith('UQ')) {
                    // Получаем workchain (0 для EQ, -1 для UQ)
                    const workchain = address.startsWith('EQ') ? '0' : '-1';
                    
                    // Убираем префикс и декодируем base64url
                    const base64 = address.slice(2)
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');
                    
                    // Добавляем padding если нужно
                    const paddedBase64 = base64 + '='.repeat((4 - base64.length % 4) % 4);
                    
                    try {
                        const bytes = atob(paddedBase64);
                        const hex = Array.from(bytes, byte => 
                            ('0' + byte.charCodeAt(0).toString(16)).slice(-2)
                        ).join('');
                        
                        return `${workchain}:${hex}`;
                    } catch (e) {
                        addDebugLog(`Ошибка декодирования base64: ${e.message}`);
                        return address;
                    }
                }
                
                return address;
            } catch (error) {
                addDebugLog(`Ошибка конвертации в RAW: ${error.message}`);
                return address;
            }
        }

        // Функция отображения сообщений
        function showMessage(title, message, isSuccess = false) {
            const errorTitle = errorWindow.querySelector('.error-title');
            const errorMsg = errorWindow.querySelector('.error-message');
            
            errorTitle.textContent = title;
            errorMsg.textContent = message;
            
            if (isSuccess) {
                errorWindow.classList.add('success');
            } else {
                errorWindow.classList.remove('success');
            }
            
            errorWindow.classList.add('show');
            
            setTimeout(() => {
                errorWindow.classList.remove('show');
            }, 5000);
        }

        function showError(title, message) {
            showMessage(title, message, false);
        }

        function showSuccess(title, message) {
            showMessage(title, message, true);
        }

        // Функция обновления статуса подключения
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                networkStatus.textContent = 'Подключено к TON';
                walletInfo.style.display = 'block';
                balanceSection.style.display = 'block';
                sendSection.style.display = 'block';
                debugSection.style.display = 'block';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                networkStatus.textContent = 'Не подключено';
                walletInfo.style.display = 'none';
                balanceSection.style.display = 'none';
                sendSection.style.display = 'none';
                debugSection.style.display = 'none';
            }
        }

        // Функция получения баланса GGCoin
        async function getGGCoinBalance(address) {
            try {
                // Конвертируем адрес в RAW формат для API
                const rawAddress = convertToRawAddress(address);
                
                addDebugLog('=== НАЧАЛО ПОИСКА ТОКЕНА ===');
                addDebugLog(`Адрес владельца (исходный): ${address}`);
                addDebugLog(`Адрес владельца (RAW для API): ${rawAddress}`);
                addDebugLog(`Ищем токен (RAW): ${GGCOIN_TOKEN_ADDRESS_RAW}`);
                addDebugLog(`Ищем токен (User-friendly): ${GGCOIN_TOKEN_ADDRESS_USER_FRIENDLY}`);
                
                const apiUrl = `https://tonapi.io/v2/accounts/${rawAddress}/jettons?limit=100`;
                addDebugLog(`API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                addDebugLog(`API запрос выполнен. Статус: ${response.status}`);
                
                if (data.jettons && data.jettons.length > 0) {
                    addDebugLog(`Найдено ${data.jettons.length} токенов у владельца:`);
                    
                    // Показываем все найденные токены
                    data.jettons.forEach((jetton, index) => {
                        addDebugLog(`${index + 1}. ${jetton.jetton.symbol || 'Unknown'} (${jetton.jetton.name || 'Unknown'})`);
                        addDebugLog(`   Адрес: ${jetton.jetton.address}`);
                        addDebugLog(`   Баланс: ${jetton.balance}`);
                        addDebugLog(`   Jetton кошелек: ${jetton.wallet_address.address}`);
                        addDebugLog('   ---');
                    });
                    
                    for (const jetton of data.jettons) {
                        // Проверяем по обеим форматам адреса
                        if (jetton.jetton.address === GGCOIN_TOKEN_ADDRESS_RAW || 
                            jetton.jetton.address === GGCOIN_TOKEN_ADDRESS_USER_FRIENDLY) {
                            const balance = parseFloat(jetton.balance) / Math.pow(10, jetton.jetton.decimals || 9);
                            jettonWalletAddress = jetton.wallet_address.address;
                            addDebugLog('✅ НАЙДЕН ИСКОМЫЙ ТОКЕН!');
                            addDebugLog(`Найден по адресу: ${jetton.jetton.address}`);
                            addDebugLog(`Баланс: ${balance}`);
                            addDebugLog(`Jetton кошелек: ${jettonWalletAddress}`);
                            return balance;
                        }
                    }
                } else {
                    addDebugLog('У этого адреса нет jetton токенов или ошибка API');
                    if (data.error) {
                        addDebugLog(`Ошибка API: ${JSON.stringify(data.error)}`);
                    }
                }
                
                addDebugLog('❌ ТОКЕН НЕ НАЙДЕН');
                addDebugLog('Возможные причины:');
                addDebugLog('1. Неправильный адрес токена');
                addDebugLog('2. У кошелька нет этого токена');
                addDebugLog('3. Токен имеет нулевой баланс');
                return 0;
            } catch (error) {
                addDebugLog(`ОШИБКА API: ${error.message}`);
                showError('Ошибка', 'Не удалось получить баланс: ' + error.message);
                return 0;
            }
        }

        // Функция отображения баланса
        function displayBalance(balance) {
            if (balance > 0) {
                balanceDisplay.innerHTML = `
                    <div class="balance-item">
                        <div class="token-symbol">GGCoin</div>
                        <div class="balance-amount">${balance.toFixed(4)}</div>
                    </div>
                `;
            } else {
                balanceDisplay.innerHTML = '<div class="loading">GGCoin не найден</div>';
            }
        }

        // Функция обновления информации о кошельке
        async function updateWalletInfo() {
            if (!walletAddress) return;
            
            try {
                refreshBalanceBtn.disabled = true;
                balanceDisplay.innerHTML = '<div class="loading">Загрузка баланса...</div>';
                
                ggcoinBalance = await getGGCoinBalance(walletAddress);
                displayBalance(ggcoinBalance);
                
            } catch (error) {
                showError('Ошибка обновления', error.message);
            } finally {
                refreshBalanceBtn.disabled = false;
            }
        }

        // Функция создания jetton transfer транзакции
        function createJettonTransferTransaction(amount) {
            const amountInNano = Math.floor(parseFloat(amount) * Math.pow(10, 9));
            
            return {
                validUntil: Math.floor(Date.now() / 1000) + 300, // 5 минут
                messages: [{
                    address: jettonWalletAddress,
                    amount: '100000000', // 0.1 TON за газ
                    payload: 'te6cckEBAgEAXAABbQ+KfqUAAAAAAAAAAEO5rKAKABRvbsEuKHO4Z1qxiOQBTKp7kqXvCjHMIDOKI6uw2a7IAS/LSdGqb1hLbLG3DnJJb1I32R3iGp6qpvYkQWGgAgEAVQAAAABHREZPQVVMVF9HQVMgRkVFIEZPUiBKRVRUT04gVFJBTlNGRVKUokcH'
                }]
            };
        }

        // Функция отправки jetton транзакции
        async function sendJettonTransaction(amount) {
            try {
                if (!tonConnectUI || !jettonWalletAddress) {
                    throw new Error('Кошелек не подключен или jetton кошелек не найден');
                }

                if (parseFloat(amount) > ggcoinBalance) {
                    throw new Error('Недостаточно средств');
                }

                sendTransactionBtn.disabled = true;
                sendTransactionBtn.textContent = 'Отправка...';

                const transaction = createJettonTransferTransaction(amount);
                const result = await tonConnectUI.sendTransaction(transaction);

                showSuccess('Успех', 'Транзакция отправлена!');
                console.log('Транзакция отправлена:', result);
                
                // Обновляем баланс через 3 секунды
                setTimeout(updateWalletInfo, 3000);

            } catch (error) {
                console.error('Ошибка отправки транзакции:', error);
                showError('Ошибка отправки', error.message);
            } finally {
                sendTransactionBtn.disabled = false;
                sendTransactionBtn.textContent = 'Отправить';
            }
        }

        // Инициализация TON Connect
        function initializeTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-button'
                });

                // Обработчик изменения статуса подключения
                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        const rawAddress = wallet.account.address;
                        walletAddress = rawAddress; // Используем адрес как есть
                        
                        addDebugLog('=== ПОДКЛЮЧЕНИЕ КОШЕЛЬКА ===');
                        addDebugLog(`Адрес из кошелька: ${rawAddress}`);
                        addDebugLog(`Цепь: ${wallet.account.chain}`);
                        addDebugLog(`Публичный ключ: ${wallet.account.publicKey}`);
                        
                        walletAddressElement.textContent = `Адрес: ${walletAddress}`;
                        updateConnectionStatus(true);
                        await updateWalletInfo();
                    } else {
                        addDebugLog('Кошелек отключен');
                        walletAddress = null;
                        updateConnectionStatus(false);
                    }
                });

                updateConnectionStatus(false);
                console.log('TON Connect инициализирован');

            } catch (error) {
                console.error('Ошибка инициализации TON Connect:', error);
                showError('Ошибка инициализации', 'Не удалось инициализировать TON Connect');
            }
        }

        // Обработчики событий
        refreshBalanceBtn.addEventListener('click', updateWalletInfo);

        disconnectWalletBtn.addEventListener('click', async () => {
            try {
                if (tonConnectUI) {
                    await tonConnectUI.disconnect();
                }
            } catch (error) {
                showError('Ошибка отключения', error.message);
            }
        });

        sendTransactionBtn.addEventListener('click', async () => {
            const amount = sendAmountInput.value;
            if (!amount || parseFloat(amount) <= 0) {
                showError('Ошибка', 'Введите корректную сумму');
                return;
            }
            await sendJettonTransaction(amount);
        });

        // Запуск приложения
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Приложение загружено, инициализация...');
            // Даем время на загрузку библиотек
            setTimeout(initializeTonConnect, 500);
        });
    </script>
</body>
</html>