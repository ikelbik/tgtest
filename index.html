<!DOCTYPE html>
<html>
<head>
    <meta name="telegram:verify" content="VERIFICATION_CODE_OT_BOTFATHER">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">	
    <link rel="manifest" href="https://ikelbik.github.io/tgtest/app-manifest.json">
    <link rel="icon" type="image/png" href="https://ikelbik.github.io/tgtest/favicon.png">    
    <meta charset="UTF-8">
    <meta name="theme-color" content="#000022">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; touch-action: none }
        body { background: #000022 }
        html, body, #game-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .menu-container {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        .menu-button {
            width: 70px;
            height: 70px;
            background: rgba(30, 30, 80, 0.8);
            border: 2px solid #4a6fff;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        .menu-button:hover {
            background: rgba(60, 60, 150, 0.9);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div id="game"></div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Функция для создания меню
        function createMenu(scene) {
            const menuContainer = document.createElement('div');
            menuContainer.className = 'menu-container';
            
            const buttons = [
                { text: 'Играть', scene: 'MainScene' },
                { text: 'Инфо', scene: 'InfoScene' },
                { text: 'Настройки', scene: 'SettingsScene' },
                { text: 'Выход', action: () => { if (window.Telegram?.WebApp) window.Telegram.WebApp.close(); } }
            ];
            
            buttons.forEach((btn, index) => {
                const button = document.createElement('div');
                button.className = 'menu-button';
                button.innerHTML = btn.text;
                
                button.addEventListener('click', () => {
                    if (btn.scene) {
                        scene.scene.start(btn.scene);
                    } else if (btn.action) {
                        btn.action();
                    }
                });
                
                menuContainer.appendChild(button);
            });
            
            document.body.appendChild(menuContainer);
            return menuContainer;
        }

        // Класс сцены загрузки
        class LoadScene extends Phaser.Scene {
            constructor() {
                super({ key: 'LoadScene' });
                this.loadProgress = 0;
                this.isLoading = true;
            }

            init() {
                this.cameras.main.setBackgroundColor('#000022');
                
                this.load.on('progress', (value) => {
                    this.loadProgress = value;
                    this.updateProgressBar();
                });
                
                this.load.on('filecomplete', (key) => {
                    if (key === 'loadscreen' && !this.bg) {
                        this.showLoadScreen();
                    }
                });
                
                this.load.on('complete', () => {
                    this.isLoading = false;
                    this.time.delayedCall(500, () => {
                        this.showPlayButton();
                    });
                });
            }

            preload() {
                this.load.setBaseURL('https://ikelbik.github.io/tgtest');
                this.load.image('loadscreen', 'assets/loadscreen.jpg');
                this.load.image('bg', 'assets/bg00.jpg');
                this.load.image('bg01', 'assets/bg01.png');	
                this.load.image('bg02', 'assets/bg02.png');				
                this.load.obj('coin', 'assets/ggcoin.obj');
                this.load.image('texture', 'assets/coin_txt_n.png');
                this.load.image('coin_t0', 'assets/coin_c00.png');
                this.load.image('coin_t1', 'assets/coin_c01.png');
                this.load.image('coin_t2', 'assets/coin_c02.png');
                this.load.image('coin_t3', 'assets/coin_c03.png');				
                this.load.image('cshdw', 'assets/shd_txt.png');
                this.load.audio('coinDrop', 'assets/drop.mp3');
                this.load.audio('coinUp', 'assets/up.mp3');
                this.load.audio('magic', 'assets/rise.wav');  
                this.load.atlas('flares', 'assets/flares.png', 'assets/flares.json');
            }

            showLoadScreen() {
                this.bg = this.add.image(this.cameras.main.centerX, this.cameras.main.centerY, 'loadscreen');
                const scaleX = this.cameras.main.width / this.bg.width;
                const scaleY = this.cameras.main.height / this.bg.height;
                const scale = Math.max(scaleX, scaleY);
                this.bg.setScale(scale);
                this.createProgressBarUI();
            }

            createProgressBarUI() {
                this.createProgressBar();
                this.loadingText = this.add.text(this.cameras.main.centerX, this.cameras.main.height - 200, 
                    'Загрузка...', {
                    font: '28px Arial',
                    fill: '#1',
                    align: 'center'
                }).setOrigin(0.5);
            }

            create() {
                if (!this.bg) {
                    this.time.delayedCall(100, () => {
                        if (this.textures.exists('loadscreen')) {
                            this.showLoadScreen();
                        } else {
                            this.bg = this.add.rectangle(this.cameras.main.centerX, this.cameras.main.centerY, 
                                                       this.cameras.main.width, this.cameras.main.height, 0x000044);
                            this.createProgressBarUI();
                        }
                    });
                }
            }

            createProgressBar() {
                const barWidth = 300;
                const barHeight = 20;
                const x = this.cameras.main.centerX - barWidth / 2;
                const y = this.cameras.main.height - 250;

                this.progressBg = this.add.graphics();
                this.progressBg.fillStyle(0x222222, 0.8);
                this.progressBg.fillRoundedRect(x, y, barWidth, barHeight, 10);
                
                this.progressBorder = this.add.graphics();
                this.progressBorder.lineStyle(2, 0xffffff, 0.8);
                this.progressBorder.strokeRoundedRect(x, y, barWidth, barHeight, 10);

                this.progressBar = this.add.graphics();
                this.percentText = this.add.text(this.cameras.main.centerX, y + barHeight / 2, '0%', {
                    font: '16px Arial',
                    fill: '#ffffff'
                }).setOrigin(0.5);
            }

            updateProgressBar() {
                if (!this.progressBar) return;
                
                const barWidth = 300;
                const barHeight = 20;
                const x = this.cameras.main.centerX - barWidth / 2;
                const y = this.cameras.main.height - 250;
                
                this.progressBar.clear();
                const progress = this.loadProgress;
                const fillWidth = barWidth * progress;
                
                if (fillWidth > 0) {
                    const color = Phaser.Display.Color.Interpolate.ColorWithColor(
                        { r: 100, g: 150, b: 255 },
                        { r: 100, g: 255, b: 100 },
                        100,
                        Math.floor(progress * 100)
                    );
                    
                    this.progressBar.fillStyle(Phaser.Display.Color.GetColor(color.r, color.g, color.b));
                    this.progressBar.fillRoundedRect(x, y, fillWidth, barHeight, 10);
                }
                
                if (this.percentText) {
                    this.percentText.setText(Math.floor(progress * 100) + '%');
                }
                
                if (this.loadingText) {
                    if (progress < 1) {
                        this.loadingText.setText('Загрузка... ' + Math.floor(progress * 100) + '%');
                    } else {
                        this.loadingText.setText('Загрузка завершена!');
                    }
                }
            }

            showPlayButton() {
                this.progressBg.setVisible(false);
                this.progressBorder.setVisible(false);
                this.progressBar.setVisible(false);
                this.percentText.setVisible(false);
                this.loadingText.setVisible(false);
                
                if (tg) {
                    tg.MainButton.setText('Играть');
                    tg.MainButton.show();
                    tg.MainButton.onClick(() => {
                        this.scene.start('MainScene');
                    });
                }
            }
        }

        // Класс сцены меню
        class MenuScene extends Phaser.Scene {
            constructor() {
                super({ key: 'MenuScene' });
            }

            create() {
                this.cameras.main.setBackgroundColor('#000022');
                this.add.text(this.cameras.main.centerX, 200, 'МЕНЮ', { 
                    fontSize: '48px', 
                    fill: '#4a6fff',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                // Создаем меню
                this.menu = createMenu(this);
                
                // Скрываем кнопку Telegram
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.MainButton.hide();
                }
            }
            
            shutdown() {
                // Удаляем меню при переходе на другую сцену
                if (this.menu) {
                    this.menu.remove();
                }
            }
        }

        // Конфигурация игры
        const config = {
            type: Phaser.WEBGL,
            parent: 'game',
            scene: [LoadScene, MenuScene],
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1024,
                height: 1920,
                resolution: Math.max(window.devicePixelRatio || 1, 1),
            },
            cameras: {
                default: {
                    zoom: 1,
                    near: -1000,
                    far: 1000,
                    position: { x: 0, y: 0, z: 100 }
                }
            },
            input: { 
                activePointers: 2 
            },
            fps: { 
                target: 60,
                smoothStep: true 
            },
            render: { 
                antialiasGL: true,
                pixelArt: false
            }
        };

        // Инициализация Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // Адаптация под Android
        if (navigator.userAgent.toLowerCase().includes('android')) {
            document.body.style.height = `${window.innerHeight}px`;
            setTimeout(() => {
                document.body.style.height = `${window.innerHeight}px`;
            }, 1000);
        }	   
        
        // Создание игры
        setTimeout(() => {
            const game = new Phaser.Game(config);
            window.addEventListener('resize', () => {
                if (game && game.scale) {
                    game.scale.refresh();
                }
            });
        }, 300);
        
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
    
    <!-- Подключаем основную сцену из отдельного файла -->
    <script src="mainscene.js"></script>
</body>
</html>