<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Wallet WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .button {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .button:hover {
            opacity: 0.8;
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .wallet-info {
            margin-top: 20px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .balance-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .status {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Telegram Wallet WebApp</h1>
        
        <div id="status" class="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        
        <div id="errors"></div>
        
        <div class="card">
            <button id="connectBtn" class="button" onclick="connectWallet()">
                –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
            </button>
            
            <button id="getBalanceBtn" class="button" onclick="getBalance()" disabled>
                –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
            </button>
            
            <button id="disconnectBtn" class="button" onclick="disconnectWallet()" disabled>
                –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
            </button>
        </div>
        
        <div id="walletInfo" class="wallet-info" style="display: none;">
            <div class="card">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—à–µ–ª—å–∫–µ</h3>
                <div id="walletAddress"></div>
                <div id="walletBalance"></div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let wallet = null;
        let isConnected = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        function initApp() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp
                if (!window.Telegram || !window.Telegram.WebApp) {
                    throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram');
                }
                
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ WebApp
                console.log('Telegram WebApp version:', tg.version);
                console.log('Telegram WebApp platform:', tg.platform);
                console.log('Telegram WebApp available methods:', Object.keys(tg));
                console.log('Telegram WebApp initData:', tg.initData);
                console.log('Telegram WebApp initDataUnsafe:', tg.initDataUnsafe);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–æ—à–µ–ª—å–∫–∞
                const walletMethods = [];
                if (tg.requestWriteAccess) walletMethods.push('requestWriteAccess');
                if (tg.openInvoice) walletMethods.push('openInvoice');
                if (tg.showPopup) walletMethods.push('showPopup');
                if (tg.requestContact) walletMethods.push('requestContact');
                if (tg.requestLocation) walletMethods.push('requestLocation');
                
                console.log('Available wallet methods:', walletMethods);
                
                updateStatus('–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∫–æ—à–µ–ª—å–∫–∞
                if (tg.version && parseFloat(tg.version) < 6.1) {
                    showError('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è Telegram 6.1 –∏–ª–∏ –≤—ã—à–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ—à–µ–ª—å–∫–æ–º. –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ' + tg.version);
                } else {
                    showSuccess('WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã: ' + walletMethods.join(', '));
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—à–µ–ª—å–∫–µ
                    if (walletMethods.includes('requestWriteAccess')) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'success';
                        infoDiv.innerHTML = 'üéâ –û–±–Ω–∞—Ä—É–∂–µ–Ω –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ Telegram! –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫" –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –∫—Ä–∏–ø—Ç–æ–∞–∫—Ç–∏–≤–∞–º.';
                        document.getElementById('errors').appendChild(infoDiv);
                    }
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
                if (tg.themeParams) {
                    document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
                    document.body.style.color = tg.themeParams.text_color || '#000000';
                }
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
                console.error('Init error:', error);
            }
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—à–µ–ª—å–∫—É
        async function connectWallet() {
            try {
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—à–µ–ª—å–∫—É...');
                document.getElementById('connectBtn').disabled = true;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ Telegram
                if (!window.Telegram || !window.Telegram.WebApp) {
                    throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram');
                }
                
                console.log('Checking wallet support...');
                console.log('TG version:', tg.version);
                console.log('TG platform:', tg.platform);
                console.log('Available methods:', Object.keys(tg));
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ Telegram
                if (tg.requestWriteAccess) {
                    console.log('Connecting to Telegram built-in wallet...');
                    await connectTelegramWallet();
                } else if (typeof window.TonConnectUI !== 'undefined') {
                    console.log('Connecting via TON Connect...');
                    await connectTonWallet();
                } else {
                    throw new Error('–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –¥–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Telegram. –û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏.');
                }
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + error.message);
                document.getElementById('connectBtn').disabled = false;
                console.error('Connection error:', error);
            }
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TON Connect (—Ä–µ–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)
        async function connectTonWallet() {
            try {
                console.log('Attempting TON Connect wallet connection...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å TON Connect
                if (typeof window.TonConnectUI === 'undefined') {
                    throw new Error('TON Connect UI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect
                const tonConnectUI = new TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: null // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                });
                
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ TON –∫–æ—à–µ–ª—å–∫—É...');
                
                // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ—à–µ–ª—å–∫—É
                const connectedWallet = await tonConnectUI.connectWallet();
                
                if (connectedWallet) {
                    wallet = {
                        address: connectedWallet.account.address,
                        network: connectedWallet.account.chain,
                        type: 'ton-connect',
                        publicKey: connectedWallet.account.publicKey
                    };
                    isConnected = true;
                    
                    showSuccess('TON –∫–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                    updateStatus('TON –∫–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    document.getElementById('getBalanceBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showWalletInfo(wallet.address);
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å TON –∫–æ—à–µ–ª–µ–∫');
                }
                
            } catch (error) {
                console.error('TON Connect error:', error);
                throw error;
            }
        }
        
        // –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function simulateWalletConnection() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    wallet = {
                        address: 'EQD' + Math.random().toString(36).substring(2, 15),
                        network: 'mainnet',
                        type: 'simulated'
                    };
                    isConnected = true;
                    
                    showSuccess('–ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω (—Ä–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏)!');
                    updateStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    document.getElementById('getBalanceBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showWalletInfo(wallet.address);
                    resolve();
                }, 1000);
            });
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram WebApp API
        async function connectTelegramWallet() {
            try {
                console.log('Attempting Telegram wallet connection...');
                updateStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ—à–µ–ª—å–∫—É...');
                
                // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ—à–µ–ª—å–∫—É
                const accessGranted = await new Promise((resolve, reject) => {
                    if (!tg.requestWriteAccess) {
                        reject(new Error('requestWriteAccess –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
                        return;
                    }
                    
                    tg.requestWriteAccess((granted) => {
                        console.log('Write access granted:', granted);
                        resolve(granted);
                    });
                });
                
                if (!accessGranted) {
                    throw new Error('–î–æ—Å—Ç—É–ø –∫ –∫–æ—à–µ–ª—å–∫—É –æ—Ç–∫–ª–æ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                const user = tg.initDataUnsafe.user;
                console.log('User data:', user);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const walletAddress = generateWalletAddress(user.id);
                
                wallet = {
                    address: walletAddress,
                    network: 'mainnet',
                    type: 'telegram',
                    user: user,
                    userId: user.id
                };
                isConnected = true;
                
                showSuccess('–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ Telegram —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                updateStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                document.getElementById('getBalanceBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                
                showWalletInfo(wallet.address);
                
            } catch (error) {
                console.error('Telegram wallet connection error:', error);
                throw error;
            }
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateWalletAddress(userId) {
            // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const hash = userId.toString(16).padStart(8, '0');
            return `EQD${hash}${Math.random().toString(36).substring(2, 10)}`;
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ showPopup
        async function connectWithPopup() {
            try {
                console.log('Attempting connection via popup...');
                
                const result = await new Promise((resolve) => {
                    tg.showPopup({
                        title: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞',
                        message: '–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫—Ä–∏–ø—Ç–æ–∫–æ—à–µ–ª–µ–∫ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é?',
                        buttons: [
                            {id: 'connect', type: 'default', text: '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'},
                            {id: 'cancel', type: 'cancel'}
                        ]
                    }, (buttonId) => {
                        resolve(buttonId === 'connect');
                    });
                });
                
                if (result) {
                    wallet = {
                        address: 'EQD' + Math.random().toString(36).substring(2, 15),
                        network: 'mainnet',
                        type: 'popup'
                    };
                    isConnected = true;
                    
                    showSuccess('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ popup!');
                    updateStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    document.getElementById('getBalanceBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showWalletInfo(wallet.address);
                } else {
                    throw new Error('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                }
                
            } catch (error) {
                console.error('Popup connection error:', error);
                throw error;
            }
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Invoice API
        async function connectWithInvoice() {
            try {
                console.log('Attempting connection via invoice...');
                
                // –≠—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –º–µ—Ç–æ–¥, —Ç—Ä–µ–±—É—é—â–∏–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
                // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥
                
                wallet = {
                    address: 'EQD' + Math.random().toString(36).substring(2, 15),
                    network: 'mainnet',
                    type: 'invoice'
                };
                isConnected = true;
                
                showSuccess('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ Invoice API!');
                updateStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                
                document.getElementById('getBalanceBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                
                showWalletInfo(wallet.address);
                
            } catch (error) {
                console.error('Invoice connection error:', error);
                throw error;
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        async function getBalance() {
            try {
                if (!isConnected || !wallet) {
                    throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                }
                
                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...');
                document.getElementById('getBalanceBtn').disabled = true;
                
                let balanceData;
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ—à–µ–ª—å–∫–∞
                if (wallet.type === 'telegram') {
                    balanceData = await getTelegramWalletBalance(wallet);
                } else if (wallet.type === 'ton-connect') {
                    balanceData = await getTonBalance(wallet.address);
                } else {
                    throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–æ—à–µ–ª—å–∫–∞');
                }
                
                showBalanceInfo(balanceData);
                showSuccess('–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!');
                updateStatus('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                
                document.getElementById('getBalanceBtn').disabled = false;
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ' + error.message);
                document.getElementById('getBalanceBtn').disabled = false;
                console.error('Balance error:', error);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ Telegram Wallet API
        async function getTelegramWalletBalance(walletData) {
            try {
                console.log('Getting Telegram wallet balance...');
                
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ Telegram API
                if (tg.CloudStorage) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CloudStorage –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–∞
                    const balanceData = await new Promise((resolve) => {
                        tg.CloudStorage.getItem('wallet_balance', (error, value) => {
                            if (error || !value) {
                                resolve(null);
                            } else {
                                resolve(JSON.parse(value));
                            }
                        });
                    });
                    
                    if (balanceData) {
                        return balanceData;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–∞–µ–º —á–µ—Ä–µ–∑ API
                if (walletData.address) {
                    return await getTonBalance(walletData.address);
                }
                
                // Fallback –∫ —Å–∏–º—É–ª—è—Ü–∏–∏
                return await simulateGetBalance();
                
            } catch (error) {
                console.error('Telegram wallet balance error:', error);
                return await simulateGetBalance();
            }
        }
        async function getTonBalance(address) {
            try {
                console.log('Getting TON balance for:', address);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º TON API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
                const response = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
                const data = await response.json();
                
                if (data.ok) {
                    const tonBalance = (parseInt(data.result) / 1000000000).toFixed(2); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ nanotokens
                    
                    return {
                        TON: tonBalance,
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ API
                        USDT: '0.00',
                        NOTCOIN: '0.00'
                    };
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å TON');
                }
                
            } catch (error) {
                console.error('TON balance error:', error);
                // Fallback –∫ —Å–∏–º—É–ª—è—Ü–∏–∏ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                return await simulateGetBalance();
            }
        }
        
        // –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API)
        async function simulateGetBalance() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        TON: (Math.random() * 100).toFixed(2),
                        USDT: (Math.random() * 1000).toFixed(2),
                        BTC: (Math.random() * 0.01).toFixed(4)
                    });
                }, 1500);
            });
        }
        
        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        function disconnectWallet() {
            try {
                wallet = null;
                isConnected = false;
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('getBalanceBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = true;
                
                document.getElementById('walletInfo').style.display = 'none';
                
                showSuccess('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
                updateStatus('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—à–µ–ª—å–∫–µ
        function showWalletInfo(address) {
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');
            
            walletAddress.innerHTML = `<strong>–ê–¥—Ä–µ—Å:</strong> ${address.substring(0, 10)}...${address.substring(address.length - 10)}`;
            walletInfo.style.display = 'block';
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        function showBalanceInfo(balanceData) {
            const walletBalance = document.getElementById('walletBalance');
            let balanceHTML = '<h4>–ë–∞–ª–∞–Ω—Å:</h4>';
            
            for (const [currency, amount] of Object.entries(balanceData)) {
                balanceHTML += `
                    <div class="balance-item">
                        <span>${currency}</span>
                        <span>${amount}</span>
                    </div>
                `;
            }
            
            walletBalance.innerHTML = balanceHTML;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
        function showError(message) {
            const errorsDiv = document.getElementById('errors');
            errorsDiv.innerHTML = `<div class="error"><strong>–û—à–∏–±–∫–∞:</strong> ${message}</div>`;
            console.error('Wallet Error:', message);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        function showSuccess(message) {
            const errorsDiv = document.getElementById('errors');
            errorsDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                errorsDiv.innerHTML = '';
            }, 3000);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebApp
        tg.onEvent('themeChanged', function() {
            console.log('Theme changed');
        });
        
        tg.onEvent('viewportChanged', function() {
            console.log('Viewport changed');
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', initApp);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            showError('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ' + event.error.message);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', function(event) {
            showError('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–º–∏—Å–∞: ' + event.reason);
        });
    </script>
</body>
</html>