<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Space WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .subtitle {
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .wallet-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .wallet-info {
            display: none;
            margin-top: 15px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            padding: 10px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balances-section {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .token-info {
            display: flex;
            align-items: center;
        }

        .token-symbol {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
            margin-right: 8px;
        }

        .token-name {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .balance-amount {
            font-size: 16px;
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #0088cc);
        }

        .balance-loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-window {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .error-window.show {
            transform: translateX(0);
        }

        .error-window.success {
            background: #28a745;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            font-size: 14px;
            line-height: 1.4;
        }

        .actions-section {
            margin-top: 20px;
        }

        .action-group {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .action-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--tg-theme-accent-text-color, #0088cc);
        }

        .recipient-info {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: var(--tg-theme-text-color, #000000);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: " ⏳";
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        #ton-connect-button {
            margin-bottom: 15px;
        }

        .network-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            text-align: center;
            margin-top: 20px;
        }

        .transaction-history {
            margin-top: 20px;
        }

        .transaction-item {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .transaction-hash {
            font-family: monospace;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            word-break: break-all;
        }

        .transaction-amount {
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #0088cc);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">TON Space WebApp</div>
            <div class="subtitle">Подключение к TON кошельку</div>
        </div>

        <div class="wallet-section">
            <div id="ton-connect-button"></div>
            
            <div class="wallet-info" id="wallet-info">
                <div class="wallet-address" id="wallet-address">Адрес: ...</div>
                <button class="btn btn-secondary" id="refresh-balance">Обновить баланс</button>
                <button class="btn btn-danger" id="disconnect-wallet">Отключить кошелек</button>
            </div>
        </div>

        <div class="balances-section" id="balances-section" style="display: none;">
            <div class="action-title">Баланс токенов</div>
            <div id="balances-list">
                <div class="balance-loading">Загрузка балансов...</div>
            </div>
        </div>

        <div class="actions-section" id="actions-section" style="display: none;">
            <div class="action-group">
                <div class="action-title">Отправить TON</div>
                <div class="input-group">
                    <label class="input-label">Адрес получателя:</label>
                    <div class="recipient-info">UQBak6BF62bcdFXplIcoOtrh45eVpECUI9ZdymxixK501w-h</div>
                </div>
                <div class="input-group">
                    <label class="input-label">Сумма (TON):</label>
                    <input type="number" class="input-field" id="send-amount" placeholder="0.1" step="0.01" min="0.01">
                </div>
                <button class="btn btn-primary" id="send-transaction">Отправить</button>
            </div>



            <div class="transaction-history" id="transaction-history">
                <div class="action-title">История транзакций</div>
                <div id="transactions-list"></div>
            </div>
        </div>

        <div class="network-info">
            <span class="status-indicator" id="status-indicator"></span>
            <span id="network-status">Инициализация...</span>
        </div>
    </div>

    <div class="error-window" id="error-window">
        <div class="error-title">Ошибка</div>
        <div class="error-message" id="error-message"></div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Конфигурация TON Connect
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        // Элементы DOM
        const walletInfo = document.getElementById('wallet-info');
        const walletAddressElement = document.getElementById('wallet-address');
        const balancesSection = document.getElementById('balances-section');
        const balancesList = document.getElementById('balances-list');
        const actionsSection = document.getElementById('actions-section');
        const refreshBalanceBtn = document.getElementById('refresh-balance');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet');
        const sendTransactionBtn = document.getElementById('send-transaction');
        const sendAmountInput = document.getElementById('send-amount');
        const statusIndicator = document.getElementById('status-indicator');
        const networkStatus = document.getElementById('network-status');
        const transactionsList = document.getElementById('transactions-list');
        const errorWindow = document.getElementById('error-window');
        const errorMessage = document.getElementById('error-message');

        // Переменные состояния
        let walletAddress = null;
        let isConnected = false;
        let transactions = [];
        const recipientAddress = 'UQBak6BF62bcdFXplIcoOtrh45eVpECUI9ZdymxixK501w-h';

        // Функция отображения ошибок/уведомлений
        function showMessage(title, message, isSuccess = false) {
            try {
                console.log(`${title}: ${message}`);
                const errorWindow = document.getElementById('error-window');
                const errorTitle = errorWindow.querySelector('.error-title');
                const errorMsg = errorWindow.querySelector('.error-message');
                
                errorTitle.textContent = title;
                errorMsg.textContent = message;
                
                if (isSuccess) {
                    errorWindow.classList.add('success');
                } else {
                    errorWindow.classList.remove('success');
                }
                
                errorWindow.classList.add('show');
                
                // Автоматически скрыть через 5 секунд
                setTimeout(() => {
                    errorWindow.classList.remove('show');
                }, 5000);
            } catch (e) {
                console.error('Ошибка при отображении сообщения:', e);
            }
        }

        // Функция отображения ошибок
        function showError(title, message) {
            showMessage(title, message, false);
        }

        // Функция отображения успешных уведомлений
        function showSuccess(title, message) {
            showMessage(title, message, true);
        }

        // Функция обновления статуса подключения
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                networkStatus.textContent = 'Подключено к TON';
                walletInfo.style.display = 'block';
                balancesSection.style.display = 'block';
                actionsSection.style.display = 'block';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                networkStatus.textContent = 'Не подключено';
                walletInfo.style.display = 'none';
                balancesSection.style.display = 'none';
                actionsSection.style.display = 'none';
            }
        }

        // Функция получения информации о токенах
        async function getTokenBalances(address) {
            try {
                const balances = [];
                const seenTokens = new Set();
                
                // Получаем баланс TON
                const tonResponse = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
                const tonData = await tonResponse.json();
                
                if (tonData.ok) {
                    const tonBalance = (parseInt(tonData.result) / 1000000000).toFixed(6);
                    balances.push({
                        symbol: 'TON',
                        name: 'Toncoin',
                        balance: tonBalance,
                        address: 'native',
                        rawBalance: tonData.result
                    });
                    seenTokens.add('TON');
                }

                console.log('Starting to fetch jetton balances for address:', address);

                // Специальный поиск Goblin Gotts Coin
                await searchForGoblinGottsCoin(address, balances, seenTokens);

                // 1. TON API v2 (основной источник)
                try {
                    console.log('Trying TON API v2...');
                    const jettonResponse = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons?limit=200&currencies=ton,usd`);
                    const jettonData = await jettonResponse.json();
                    
                    console.log('TON API v2 response:', jettonData);
                    
                    if (jettonData.jettons && jettonData.jettons.length > 0) {
                        for (const jetton of jettonData.jettons) {
                            const decimals = jetton.jetton.decimals || 9;
                            const rawBalance = jetton.balance || '0';
                            const balance = parseFloat(rawBalance) / Math.pow(10, decimals);
                            const symbol = jetton.jetton.symbol || 'Unknown';
                            const name = jetton.jetton.name || 'Unknown Token';
                            
                            console.log(`Found token: ${symbol} (${name}), balance: ${balance}, raw: ${rawBalance}`);
                            
                            // Специальная проверка для Goblin Gotts Coin
                            if (isGoblinGottsCoin(symbol, name)) {
                                console.log('🎯 GOBLIN GOTTS COIN FOUND:', symbol, name);
                            }
                            
                            const tokenKey = (symbol + name + jetton.jetton.address).toLowerCase();
                            if (!seenTokens.has(tokenKey)) {
                                balances.push({
                                    symbol: symbol,
                                    name: name,
                                    balance: balance.toFixed(6),
                                    address: jetton.jetton.address,
                                    rawBalance: rawBalance,
                                    decimals: decimals
                                });
                                seenTokens.add(tokenKey);
                            }
                        }
                    }
                } catch (jettonError) {
                    console.log('TON API v2 failed:', jettonError);
                }

                // 2. TONCenter API v3
                try {
                    console.log('Trying TONCenter API v3...');
                    const tcResponse = await fetch(`https://toncenter.com/api/v3/jetton/wallets?address=${address}&limit=200`);
                    const tcData = await tcResponse.json();
                    
                    console.log('TONCenter API v3 response:', tcData);
                    
                    if (tcData.jetton_wallets && tcData.jetton_wallets.length > 0) {
                        for (const wallet of tcData.jetton_wallets) {
                            const decimals = wallet.jetton.decimals || 9;
                            const rawBalance = wallet.balance || '0';
                            const balance = parseFloat(rawBalance) / Math.pow(10, decimals);
                            const symbol = wallet.jetton.symbol || 'JTN';
                            const name = wallet.jetton.name || 'Jetton Token';
                            
                            console.log(`TONCenter found token: ${symbol} (${name}), balance: ${balance}, raw: ${rawBalance}`);
                            
                            // Специальная проверка для Goblin Gotts Coin
                            if (isGoblinGottsCoin(symbol, name)) {
                                console.log('🎯 GOBLIN GOTTS COIN FOUND in TONCenter:', symbol, name);
                            }
                            
                            const tokenKey = (symbol + name + wallet.jetton.address).toLowerCase();
                            if (!seenTokens.has(tokenKey)) {
                                balances.push({
                                    symbol: symbol,
                                    name: name,
                                    balance: balance.toFixed(6),
                                    address: wallet.jetton.address,
                                    rawBalance: rawBalance,
                                    decimals: decimals
                                });
                                seenTokens.add(tokenKey);
                            }
                        }
                    }
                } catch (tcError) {
                    console.log('TONCenter API v3 failed:', tcError);
                }

                // 3. Поиск через TONKeeper API
                try {
                    console.log('Trying TONKeeper API...');
                    const tkResponse = await fetch(`https://api.tonkeeper.com/v1/jetton/wallets?owner=${address}`);
                    const tkData = await tkResponse.json();
                    
                    console.log('TONKeeper API response:', tkData);
                    
                    if (tkData && Array.isArray(tkData)) {
                        for (const wallet of tkData) {
                            if (wallet.jetton && wallet.balance) {
                                const decimals = wallet.jetton.decimals || 9;
                                const rawBalance = wallet.balance;
                                const balance = parseFloat(rawBalance) / Math.pow(10, decimals);
                                const symbol = wallet.jetton.symbol || 'TK';
                                const name = wallet.jetton.name || 'TONKeeper Token';
                                
                                console.log(`TONKeeper found token: ${symbol} (${name}), balance: ${balance}`);
                                
                                if (isGoblinGottsCoin(symbol, name)) {
                                    console.log('🎯 GOBLIN GOTTS COIN FOUND in TONKeeper:', symbol, name);
                                }
                                
                                const tokenKey = (symbol + name + wallet.jetton.address).toLowerCase();
                                if (!seenTokens.has(tokenKey)) {
                                    balances.push({
                                        symbol: symbol,
                                        name: name,
                                        balance: balance.toFixed(6),
                                        address: wallet.jetton.address,
                                        rawBalance: rawBalance,
                                        decimals: decimals
                                    });
                                    seenTokens.add(tokenKey);
                                }
                            }
                        }
                    }
                } catch (tkError) {
                    console.log('TONKeeper API failed:', tkError);
                }

                // 4. Поиск через getgems.io API
                try {
                    console.log('Trying GetGems API...');
                    const ggResponse = await fetch(`https://api.getgems.io/graphql`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                query {
                                    account(address: "${address}") {
                                        jettonBalances {
                                            balance
                                            jettonMaster {
                                                symbol
                                                name
                                                decimals
                                                address
                                            }
                                        }
                                    }
                                }
                            `
                        })
                    });
                    
                    const ggData = await ggResponse.json();
                    console.log('GetGems API response:', ggData);
                    
                    if (ggData.data && ggData.data.account && ggData.data.account.jettonBalances) {
                        for (const balance of ggData.data.account.jettonBalances) {
                            const jetton = balance.jettonMaster;
                            const decimals = jetton.decimals || 9;
                            const rawBalance = balance.balance || '0';
                            const tokenBalance = parseFloat(rawBalance) / Math.pow(10, decimals);
                            const symbol = jetton.symbol || 'GG';
                            const name = jetton.name || 'GetGems Token';
                            
                            console.log(`GetGems found token: ${symbol} (${name}), balance: ${tokenBalance}`);
                            
                            if (isGoblinGottsCoin(symbol, name)) {
                                console.log('🎯 GOBLIN GOTTS COIN FOUND in GetGems:', symbol, name);
                            }
                            
                            const tokenKey = (symbol + name + jetton.address).toLowerCase();
                            if (!seenTokens.has(tokenKey)) {
                                balances.push({
                                    symbol: symbol,
                                    name: name,
                                    balance: tokenBalance.toFixed(6),
                                    address: jetton.address,
                                    rawBalance: rawBalance,
                                    decimals: decimals
                                });
                                seenTokens.add(tokenKey);
                            }
                        }
                    }
                } catch (ggError) {
                    console.log('GetGems API failed:', ggError);
                }

                // 5. Прямой поиск через известные контракты
                await searchGoblinGottsDirectly(address, balances, seenTokens);

                // 6. Анализ всех транзакций кошелька
                await analyzeAllTransactions(address, balances, seenTokens);

                console.log('Final balances:', balances);
                
                // Проверяем, найден ли Goblin Gotts Coin
                const goblinCoinFound = balances.find(token => isGoblinGottsCoin(token.symbol, token.name));
                
                if (!goblinCoinFound) {
                    console.log('⚠️ Goblin Gotts Coin not found in any API. Adding placeholder...');
                    balances.push({
                        symbol: 'GOBLIN',
                        name: 'Goblin Gotts Coin (Not Found)',
                        balance: '0.000000',
                        address: 'unknown',
                        rawBalance: '0',
                        decimals: 9,
                        notFound: true
                    });
                }
                
                return balances;
            } catch (error) {
                console.error('Error in getTokenBalances:', error);
                showError('Ошибка баланса', error.message);
                return [{
                    symbol: 'TON',
                    name: 'Toncoin',
                    balance: '0.00',
                    address: 'native'
                }];
            }
        }

        // Функция проверки, является ли токен Goblin Gotts Coin
        function isGoblinGottsCoin(symbol, name) {
            const symbolLower = symbol.toLowerCase();
            const nameLower = name.toLowerCase();
            
            return symbolLower.includes('goblin') || 
                   symbolLower.includes('gotts') || 
                   symbolLower.includes('gg') ||
                   nameLower.includes('goblin') || 
                   nameLower.includes('gotts') || 
                   nameLower.includes('gringotts') ||
                   nameLower.includes('goblingotts') ||
                   (symbolLower.includes('g') && symbolLower.includes('g') && symbolLower.length <= 6);
        }

        // Специальная функция поиска Goblin Gotts Coin
        async function searchForGoblinGottsCoin(address, balances, seenTokens) {
            console.log('🔍 Searching specifically for Goblin Gotts Coin...');
            
            // Возможные варианты символов
            const possibleSymbols = ['GOBLIN', 'GOTTS', 'GG', 'GGCOIN', 'GOBLINGOTTS'];
            
            for (const symbol of possibleSymbols) {
                try {
                    // Поиск через различные источники
                    console.log(`Searching for symbol: ${symbol}`);
                } catch (error) {
                    console.log(`Error searching for ${symbol}:`, error);
                }
            }
        }

        // Прямой поиск Goblin Gotts Coin
        async function searchGoblinGottsDirectly(address, balances, seenTokens) {
            console.log('🔍 Direct Goblin Gotts Coin search...');
            
            try {
                // Поиск через TonScan API
                const tsResponse = await fetch(`https://tonscan.org/api/v3/jetton/masters`);
                const tsData = await tsResponse.json();
                
                console.log('TonScan masters response:', tsData);
                
                if (tsData && Array.isArray(tsData)) {
                    for (const master of tsData) {
                        if (master.symbol && master.name) {
                            if (isGoblinGottsCoin(master.symbol, master.name)) {
                                console.log('🎯 Found potential Goblin Gotts master contract:', master);
                                
                                // Проверяем баланс этого токена для нашего адреса
                                try {
                                    const walletResponse = await fetch(`https://tonscan.org/api/v3/jetton/wallets?jetton_master=${master.address}&owner=${address}`);
                                    const walletData = await walletResponse.json();
                                    
                                    if (walletData && walletData.balance) {
                                        const balance = parseFloat(walletData.balance) / Math.pow(10, master.decimals || 9);
                                        
                                        console.log('🎯 GOBLIN GOTTS COIN FOUND with balance:', balance);
                                        
                                        const tokenKey = (master.symbol + master.name + master.address).toLowerCase();
                                        if (!seenTokens.has(tokenKey)) {
                                            balances.push({
                                                symbol: master.symbol,
                                                name: master.name,
                                                balance: balance.toFixed(6),
                                                address: master.address,
                                                rawBalance: walletData.balance,
                                                decimals: master.decimals || 9
                                            });
                                            seenTokens.add(tokenKey);
                                        }
                                    }
                                } catch (walletError) {
                                    console.log('Error checking wallet for master:', master.address, walletError);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('TonScan masters search failed:', error);
            }
        }

        // Расширенный анализ транзакций
        async function analyzeAllTransactions(address, balances, seenTokens) {
            console.log('🔍 Analyzing ALL transactions for Goblin Gotts Coin...');
            
            try {
                // Получаем больше транзакций
                const txResponse = await fetch(`https://toncenter.com/api/v2/getTransactions?address=${address}&limit=200`);
                const txData = await txResponse.json();
                
                if (txData.ok && txData.result) {
                    console.log(`Analyzing ${txData.result.length} transactions...`);
                    
                    for (const tx of txData.result) {
                        // Анализируем все сообщения в транзакциях
                        const allMessages = [...(tx.in_msg ? [tx.in_msg] : []), ...(tx.out_msgs || [])];
                        
                        for (const msg of allMessages) {
                            if (msg.destination) {
                                try {
                                    // Получаем информацию о контракте
                                    const contractResponse = await fetch(`https://toncenter.com/api/v2/getAddressInformation?address=${msg.destination}`);
                                    const contractData = await contractResponse.json();
                                    
                                    if (contractData.ok && contractData.result) {
                                        // Проверяем, не jetton ли это
                                        if (contractData.result.code) {
                                            console.log('Found contract:', msg.destination);
                                            
                                            // Пытаемся получить информацию о jetton
                                            try {
                                                const jettonResponse = await fetch(`https://toncenter.com/api/v2/getTokenData?address=${msg.destination}`);
                                                const jettonData = await jettonResponse.json();
                                                
                                                if (jettonData.ok && jettonData.result) {
                                                    const symbol = jettonData.result.symbol || '';
                                                    const name = jettonData.result.name || '';
                                                    
                                                    if (isGoblinGottsCoin(symbol, name)) {
                                                        console.log('🎯 GOBLIN GOTTS COIN FOUND through transaction analysis!', jettonData.result);
                                                    }
                                                }
                                            } catch (jettonError) {
                                                // Игнорируем ошибки отдельных запросов
                                            }
                                        }
                                    }
                                } catch (contractError) {
                                    // Игнорируем ошибки отдельных запросов
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('Extended transaction analysis failed:', error);
            }
        }
                                                    console.log('🎯 GGCoin found through transaction analysis!', jettonData.result);
                                                }
                                            }
                                        } catch (error) {
                                            // Игнорируем ошибки отдельных запросов
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('Transaction analysis failed:', error);
            }
        }

        // Функция отображения балансов
        function displayBalances(balances) {
            balancesList.innerHTML = '';
            
            if (balances.length === 0) {
                balancesList.innerHTML = '<div class="balance-loading">Токены не найдены</div>';
                return;
            }
            
            console.log('Displaying balances:', balances);
            
            balances.forEach(token => {
                const balanceItem = document.createElement('div');
                balanceItem.className = 'balance-item';
                
                // Особое выделение для GGCoin
                const isGGCoin = token.symbol.toLowerCase().includes('gg') || 
                                token.name.toLowerCase().includes('gg') ||
                                token.symbol.toLowerCase() === 'ggcoin';
                
                if (isGGCoin) {
                    balanceItem.style.border = '2px solid #FFD700';
                    balanceItem.style.backgroundColor = '#FFF9E6';
                }
                
                if (token.notFound) {
                    balanceItem.style.backgroundColor = '#FFE6E6';
                    balanceItem.style.border = '1px dashed #FF9999';
                }
                
                const displayBalance = parseFloat(token.balance) === 0 ? '0.000000' : token.balance;
                const balanceOpacity = parseFloat(token.balance) > 0 ? '1' : '0.6';
                
                balanceItem.innerHTML = `
                    <div class="token-info">
                        <span class="token-symbol" style="color: ${isGGCoin ? '#FF6B35' : 'inherit'}; font-weight: ${isGGCoin ? 'bold' : 'normal'};">
                            ${isGGCoin ? '🎯 ' : ''}${token.symbol}${token.notFound ? ' ❌' : ''}
                        </span>
                        <span class="token-name">${token.name}</span>
                        ${token.rawBalance && token.rawBalance !== '0' ? `<div style="font-size: 10px; color: #999; font-family: monospace;">Raw: ${token.rawBalance}</div>` : ''}
                        ${token.address && token.address !== 'native' && token.address !== 'unknown' ? `<div style="font-size: 10px; color: #999; font-family: monospace; word-break: break-all;">Address: ${token.address.substring(0, 10)}...${token.address.substring(token.address.length - 6)}</div>` : ''}
                    </div>
                    <div class="balance-amount" style="opacity: ${balanceOpacity}; color: ${isGGCoin ? '#FF6B35' : 'inherit'}; font-weight: ${isGGCoin ? 'bold' : 'normal'};">
                        ${displayBalance}
                    </div>
                `;
                
                balancesList.appendChild(balanceItem);
            });
            
            // Добавляем информацию о поиске
            const infoItem = document.createElement('div');
            const ggcoinFound = balances.find(token => 
                token.symbol.toLowerCase().includes('gg') || 
                token.name.toLowerCase().includes('gg') ||
                token.symbol.toLowerCase() === 'ggcoin'
            );
            
            infoItem.innerHTML = `
                <div style="text-align: center; padding: 10px; font-size: 12px; color: #999;">
                    Найдено токенов: ${balances.length}<br>
                    ${ggcoinFound ? (ggcoinFound.notFound ? '⚠️ GGCoin: не найден в блокчейне' : '🎯 GGCoin: найден!') : '🔍 GGCoin: ищем...'}
                </div>
            `;
            balancesList.appendChild(infoItem);
        }

        // Функция получения транзакций
        async function getTransactions(address) {
            try {
                const response = await fetch(`https://toncenter.com/api/v2/getTransactions?address=${address}&limit=10`);
                const data = await response.json();
                
                if (data.ok) {
                    return data.result;
                } else {
                    throw new Error(data.error || 'Не удалось получить транзакции');
                }
            } catch (error) {
                showError('Ошибка транзакций', error.message);
                return [];
            }
        }

        // Функция отображения транзакций
        function displayTransactions(txs) {
            transactionsList.innerHTML = '';
            
            if (txs.length === 0) {
                transactionsList.innerHTML = '<div style="text-align: center; color: #999;">Нет транзакций</div>';
                return;
            }

            txs.forEach(tx => {
                const txElement = document.createElement('div');
                txElement.className = 'transaction-item';
                
                const amount = tx.in_msg && tx.in_msg.value ? 
                    (parseInt(tx.in_msg.value) / 1000000000).toFixed(4) : 
                    '0.00';
                
                txElement.innerHTML = `
                    <div class="transaction-amount">${amount} TON</div>
                    <div class="transaction-hash">Hash: ${tx.transaction_id.hash}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ${new Date(tx.utime * 1000).toLocaleString()}
                    </div>
                `;
                
                transactionsList.appendChild(txElement);
            });
        }

        // Функция обновления информации о кошельке
        async function updateWalletInfo() {
            if (!walletAddress) return;
            
            try {
                refreshBalanceBtn.classList.add('loading');
                balancesList.innerHTML = '<div class="balance-loading">Загрузка балансов...</div>';
                
                const balances = await getTokenBalances(walletAddress);
                displayBalances(balances);
                
                const txs = await getTransactions(walletAddress);
                displayTransactions(txs);
                
            } catch (error) {
                showError('Ошибка обновления', error.message);
            } finally {
                refreshBalanceBtn.classList.remove('loading');
            }
        }

        // Обработчики событий TON Connect
        tonConnectUI.onStatusChange(async (wallet) => {
            try {
                if (wallet) {
                    walletAddress = wallet.account.address;
                    walletAddressElement.textContent = `Адрес: ${walletAddress}`;
                    updateConnectionStatus(true);
                    await updateWalletInfo();
                } else {
                    walletAddress = null;
                    updateConnectionStatus(false);
                }
            } catch (error) {
                showError('Ошибка подключения', error.message);
            }
        });

        // Обработчики кнопок
        refreshBalanceBtn.addEventListener('click', updateWalletInfo);

        disconnectWalletBtn.addEventListener('click', async () => {
            try {
                await tonConnectUI.disconnect();
            } catch (error) {
                showError('Ошибка отключения', error.message);
            }
        });

        sendTransactionBtn.addEventListener('click', async () => {
            const amount = parseFloat(sendAmountInput.value);

            if (!amount || amount <= 0) {
                showError('Ошибка ввода', 'Введите корректную сумму');
                return;
            }

            try {
                sendTransactionBtn.classList.add('loading');
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60,
                    messages: [
                        {
                            address: recipientAddress,
                            amount: Math.floor(amount * 1000000000).toString()
                        }
                    ]
                };

                const result = await tonConnectUI.sendTransaction(transaction);
                
                if (result) {
                    showSuccess('Успех', 'Транзакция отправлена успешно!');
                    sendAmountInput.value = '';
                    
                    // Обновить баланс через 5 секунд
                    setTimeout(updateWalletInfo, 5000);
                }
            } catch (error) {
                showError('Ошибка транзакции', error.message);
            } finally {
                sendTransactionBtn.classList.remove('loading');
            }
        });

        // Обработчики Telegram WebApp
        tg.onEvent('themeChanged', () => {
            try {
                document.body.style.backgroundColor = tg.themeParams.bg_color;
                document.body.style.color = tg.themeParams.text_color;
            } catch (error) {
                showError('Ошибка темы', error.message);
            }
        });

        // Инициализация
        try {
            updateConnectionStatus(false);
            console.log('TON Connect WebApp инициализирован');
        } catch (error) {
            showError('Ошибка инициализации', error.message);
        }

        // Обработчик закрытия окна уведомлений
        errorWindow.addEventListener('click', () => {
            errorWindow.classList.remove('show');
        });

        // Периодическое обновление баланса (каждые 30 секунд)
        setInterval(() => {
            if (isConnected && walletAddress) {
                updateWalletInfo();
            }
        }, 30000);
    </script>
</body>
</html>