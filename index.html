<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGCoin WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }

        .subtitle {
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .wallet-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .wallet-info {
            display: none;
            margin-top: 15px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            padding: 10px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balances-section {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .token-info {
            display: flex;
            align-items: center;
        }

        .token-symbol {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
            margin-right: 8px;
        }

        .token-name {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .balance-amount {
            font-size: 16px;
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #0088cc);
        }

        .balance-loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .btn-secondary:hover {
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-window {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .error-window.show {
            transform: translateX(0);
        }

        .error-window.success {
            background: #28a745;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            font-size: 14px;
            line-height: 1.4;
        }

        .actions-section {
            margin-top: 20px;
        }

        .action-group {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
        }

        .action-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--tg-theme-accent-text-color, #0088cc);
        }

        .recipient-info {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: var(--tg-theme-text-color, #000000);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .loading::after {
            content: " ⏳";
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        #ton-connect-button {
            margin-bottom: 15px;
        }

        .network-info {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            text-align: center;
            margin-top: 20px;
        }

        .transaction-history {
            margin-top: 20px;
        }

        .transaction-item {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .transaction-hash {
            font-family: monospace;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            word-break: break-all;
        }

        .transaction-amount {
            font-weight: bold;
            color: var(--tg-theme-accent-text-color, #0088cc);
        }

        .token-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">GGCoin WebApp</div>
            <div class="subtitle">Подключение к TON кошельку для GGCoin</div>
        </div>

        <div class="wallet-section">
            <div id="ton-connect-button"></div>
            
            <div class="wallet-info" id="wallet-info">
                <div class="wallet-address" id="wallet-address">Адрес: ...</div>
                <button class="btn btn-secondary" id="refresh-balance">Обновить баланс</button>
                <button class="btn btn-danger" id="disconnect-wallet">Отключить кошелек</button>
            </div>
        </div>

        <div class="balances-section" id="balances-section" style="display: none;">
            <div class="action-title">Баланс GGCoin</div>
            <div id="balances-list">
                <div class="balance-loading">Загрузка балансов...</div>
            </div>
        </div>

        <div class="actions-section" id="actions-section" style="display: none;">
            <div class="action-group">
                <div class="action-title">Отправить GGCoin</div>
                <div class="input-group">
                    <label class="input-label">Адрес получателя:</label>
                    <input type="text" class="input-field" id="recipient-address" placeholder="0:..." value="UQBak6BF62bcdFXplIcoOtrh45eVpECUI9ZdymxixK501w-h">
                </div>
                <div class="input-group">
                    <label class="input-label">Сумма (GGCoin):</label>
                    <input type="number" class="input-field" id="send-amount" placeholder="100" step="1" min="1">
                </div>
                <button class="btn btn-primary" id="send-transaction">Отправить GGCoin</button>
                <button class="btn btn-secondary" id="test-connection" style="margin-top: 10px;">Тест подключения (отправить 0.001 TON)</button>
            </div>

            <div class="transaction-history" id="transaction-history">
                <div class="action-title">История транзакций</div>
                <div id="transactions-list"></div>
            </div>
        </div>

        <div class="network-info">
            <span class="status-indicator" id="status-indicator"></span>
            <span id="network-status">Загрузка...</span>
        </div>
    </div>

    <div class="error-window" id="error-window">
        <div class="error-title">Ошибка</div>
        <div class="error-message" id="error-message"></div>
    </div>

    <script>
        // Ждем полной загрузки всех скриптов
        function waitForLibraries() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 секунд максимум
                
                const checkLibraries = () => {
                    attempts++;
                    console.log(`Проверка библиотек, попытка ${attempts}...`);
                    
                    const telegramReady = window.Telegram && window.Telegram.WebApp;
                    const tonConnectReady = window.TON_CONNECT_UI;
                    
                    console.log('Telegram WebApp:', telegramReady ? 'Готов' : 'Не готов');
                    console.log('TON Connect UI:', tonConnectReady ? 'Готов' : 'Не готов');
                    
                    if (tonConnectReady || attempts >= maxAttempts) {
                        resolve({ telegramReady, tonConnectReady });
                    } else {
                        setTimeout(checkLibraries, 100);
                    }
                };
                
                checkLibraries();
            });
        }

        // Запускаем инициализацию после загрузки библиотек
        async function initApp() {
            console.log('Начинаем инициализацию приложения...');
            
            // Обновляем статус
            document.getElementById('network-status').textContent = 'Загрузка библиотек...';
            
            // Ждем загрузки библиотек
            const { telegramReady, tonConnectReady } = await waitForLibraries();
            
            if (!tonConnectReady) {
                document.getElementById('network-status').textContent = 'Ошибка загрузки TON Connect';
                showError('Ошибка загрузки', 'Не удалось загрузить TON Connect. Проверьте интернет соединение и перезагрузите страницу.');
                return;
            }

        // Инициализация с проверками
        console.log('Начинаем инициализацию...');
        
        // Проверяем наличие Telegram WebApp
        let tg = null;
        if (window.Telegram && window.Telegram.WebApp) {
            console.log('Telegram WebApp найден');
            tg = window.Telegram.WebApp;
            try {
                tg.ready();
                tg.expand();
                console.log('Telegram WebApp инициализирован');
            } catch (e) {
                console.error('Ошибка инициализации Telegram WebApp:', e);
            }
        } else {
            console.log('Telegram WebApp не найден, работаем в браузере');
        }

        // Проверяем наличие TON Connect
        let tonConnectUI = null;
        if (window.TON_CONNECT_UI) {
            console.log('TON Connect UI найден');
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-button'
                });
                console.log('TON Connect UI инициализирован');
            } catch (e) {
                console.error('Ошибка инициализации TON Connect UI:', e);
                showError('Ошибка инициализации', 'Не удалось загрузить TON Connect. Перезагрузите страницу.');
            }
        } else {
            console.error('TON Connect UI не найден');
            showError('Ошибка загрузки', 'TON Connect библиотека не загружена. Проверьте интернет соединение.');
        }

        // Тест подключения - простая TON транзакция
        testConnectionBtn.addEventListener('click', async () => {
            const recipientAddress = recipientAddressInput.value.trim();

            if (!recipientAddress) {
                showError('Ошибка ввода', 'Введите адрес получателя для теста');
                return;
            }

            try {
                testConnectionBtn.classList.add('loading');
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [
                        {
                            address: recipientAddress,
                            amount: "1000000", // 0.001 TON
                            payload: btoa(unescape(encodeURIComponent('Test connection')))
                        }
                    ]
                };

                console.log('Тестовая транзакция:', transaction);
                const result = await tonConnectUI.sendTransaction(transaction);
                
                if (result) {
                    showSuccess('Тест успешен', 'Подключение к TON Space работает! Отправлен 0.001 TON.');
                } else {
                    showError('Тест отменен', 'Тестовая транзакция была отменена');
                }
            } catch (error) {
                console.error('Ошибка тестовой транзакции:', error);
                showError('Тест не прошел', `Ошибка подключения: ${error.message}`);
            } finally {
                testConnectionBtn.classList.remove('loading');
            }

        // Адрес контракта GGCoin
        const GGCOIN_CONTRACT_ADDRESS = '0:7f82a882da388deecaa53806c44c375f697a09fd86d93e9c0e1832749b222b0b';

        // Элементы DOM
        const walletInfo = document.getElementById('wallet-info');
        const walletAddressElement = document.getElementById('wallet-address');
        const balancesSection = document.getElementById('balances-section');
        const balancesList = document.getElementById('balances-list');
        const actionsSection = document.getElementById('actions-section');
        const refreshBalanceBtn = document.getElementById('refresh-balance');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet');
        const sendTransactionBtn = document.getElementById('send-transaction');
        const testConnectionBtn = document.getElementById('test-connection');
        const sendAmountInput = document.getElementById('send-amount');
        const recipientAddressInput = document.getElementById('recipient-address');
        const statusIndicator = document.getElementById('status-indicator');
        const networkStatus = document.getElementById('network-status');
        const transactionsList = document.getElementById('transactions-list');
        const errorWindow = document.getElementById('error-window');
        const errorMessage = document.getElementById('error-message');

        // Переменные состояния
        let walletAddress = null;
        let isConnected = false;
        let transactions = [];
        let ggcoinBalance = '0';
        let jettonWalletAddress = null;

        // Функция отображения ошибок/уведомлений
        function showMessage(title, message, isSuccess = false) {
            try {
                console.log(`${title}: ${message}`);
                const errorWindow = document.getElementById('error-window');
                const errorTitle = errorWindow.querySelector('.error-title');
                const errorMsg = errorWindow.querySelector('.error-message');
                
                errorTitle.textContent = title;
                errorMsg.textContent = message;
                
                if (isSuccess) {
                    errorWindow.classList.add('success');
                } else {
                    errorWindow.classList.remove('success');
                }
                
                errorWindow.classList.add('show');
                
                // Автоматически скрыть через 5 секунд
                setTimeout(() => {
                    errorWindow.classList.remove('show');
                }, 5000);
            } catch (e) {
                console.error('Ошибка при отображении сообщения:', e);
            }
        }

        // Функция отображения ошибок
        function showError(title, message) {
            showMessage(title, message, false);
        }

        // Функция отображения успешных уведомлений
        function showSuccess(title, message) {
            showMessage(title, message, true);
        }

        // Функция обновления статуса подключения
        function updateConnectionStatus(connected) {
            isConnected = connected;
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                networkStatus.textContent = 'Подключено к TON';
                walletInfo.style.display = 'block';
                balancesSection.style.display = 'block';
                actionsSection.style.display = 'block';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                networkStatus.textContent = 'Не подключено';
                walletInfo.style.display = 'none';
                balancesSection.style.display = 'none';
                actionsSection.style.display = 'none';
            }
        }

        // Функция получения баланса GGCoin
        async function getGGCoinBalance(address) {
            try {
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons`);
                const data = await response.json();
                
                if (data.balances && data.balances.length > 0) {
                    // Находим GGCoin в списке jettons
                    const ggcoinJetton = data.balances.find(balance => 
                        balance.jetton.address === GGCOIN_CONTRACT_ADDRESS
                    );
                    
                    if (ggcoinJetton) {
                        const balance = parseFloat(ggcoinJetton.balance) / Math.pow(10, ggcoinJetton.jetton.decimals || 9);
                        jettonWalletAddress = ggcoinJetton.wallet_address.address;
                        return {
                            balance: balance.toFixed(2),
                            jettonInfo: ggcoinJetton.jetton,
                            walletAddress: jettonWalletAddress
                        };
                    }
                }
                
                return {
                    balance: '0.00',
                    jettonInfo: {
                        symbol: 'GGCoin',
                        name: 'GoblinGotts Coin',
                        decimals: 9,
                        image: ''
                    },
                    walletAddress: null
                };
            } catch (error) {
                console.error('Ошибка получения баланса GGCoin:', error);
                showError('Ошибка баланса', 'Не удалось получить баланс GGCoin');
                return {
                    balance: '0.00',
                    jettonInfo: {
                        symbol: 'GGCoin',
                        name: 'GoblinGotts Coin',
                        decimals: 9,
                        image: ''
                    },
                    walletAddress: null
                };
            }
        }

        // Функция отображения баланса GGCoin
        function displayGGCoinBalance(balanceData) {
            balancesList.innerHTML = '';
            
            const balanceItem = document.createElement('div');
            balanceItem.className = 'balance-item';
            
            const imageElement = balanceData.jettonInfo.image ? 
                `<img src="${balanceData.jettonInfo.image}" alt="${balanceData.jettonInfo.symbol}" class="token-icon">` : '';
            
            balanceItem.innerHTML = `
                <div class="token-info">
                    ${imageElement}
                    <div>
                        <span class="token-symbol">${balanceData.jettonInfo.symbol}</span>
                        <div class="token-name">${balanceData.jettonInfo.name}</div>
                    </div>
                </div>
                <div class="balance-amount">${balanceData.balance}</div>
            `;
            
            balancesList.appendChild(balanceItem);
            ggcoinBalance = balanceData.balance;
        }

        // Функция получения транзакций GGCoin
        async function getGGCoinTransactions(address) {
            try {
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons/transfers?limit=10&jetton_address=${GGCOIN_CONTRACT_ADDRESS}`);
                const data = await response.json();
                
                if (data.events) {
                    return data.events;
                }
                
                return [];
            } catch (error) {
                console.error('Ошибка получения транзакций GGCoin:', error);
                return [];
            }
        }

        // Функция отображения транзакций GGCoin
        function displayGGCoinTransactions(events) {
            transactionsList.innerHTML = '';
            
            if (events.length === 0) {
                transactionsList.innerHTML = '<div style="text-align: center; color: #999;">Нет транзакций GGCoin</div>';
                return;
            }

            events.forEach(event => {
                if (event.actions && event.actions.length > 0) {
                    const action = event.actions[0];
                    if (action.type === 'JettonTransfer') {
                        const txElement = document.createElement('div');
                        txElement.className = 'transaction-item';
                        
                        const transfer = action.JettonTransfer;
                        const amount = parseFloat(transfer.amount) / Math.pow(10, 9);
                        const isIncoming = transfer.recipient && transfer.recipient.address === walletAddress;
                        
                        txElement.innerHTML = `
                            <div class="transaction-amount">
                                ${isIncoming ? '+' : '-'}${amount.toFixed(2)} GGCoin
                            </div>
                            <div class="transaction-hash">
                                ${isIncoming ? 'От' : 'Кому'}: ${isIncoming ? 
                                    (transfer.sender ? transfer.sender.address.slice(0, 10) + '...' : 'Неизвестно') : 
                                    (transfer.recipient ? transfer.recipient.address.slice(0, 10) + '...' : 'Неизвестно')
                                }
                            </div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${new Date(event.timestamp * 1000).toLocaleString()}
                            </div>
                        `;
                        
                        transactionsList.appendChild(txElement);
                    }
                }
            });
        }

        // Функция обновления информации о кошельке
        async function updateWalletInfo() {
            if (!walletAddress) return;
            
            try {
                refreshBalanceBtn.classList.add('loading');
                balancesList.innerHTML = '<div class="balance-loading">Загрузка баланса GGCoin...</div>';
                
                const balanceData = await getGGCoinBalance(walletAddress);
                displayGGCoinBalance(balanceData);
                
                const transactions = await getGGCoinTransactions(walletAddress);
                displayGGCoinTransactions(transactions);
                
            } catch (error) {
                showError('Ошибка обновления', error.message);
            } finally {
                refreshBalanceBtn.classList.remove('loading');
            }
        }

        // Функция создания правильного Jetton Transfer payload
        function createJettonTransferPayload(toAddress, jettonAmount, forwardAmount = 1) {
            // Создаем правильный Cell для Jetton Transfer
            // Опкод для Jetton Transfer: 0x0f8a7ea5
            
            // Создаем payload в виде hex строки
            const opcode = 'f8a7ea5'; // Jetton Transfer opcode без 0x
            const queryId = Date.now().toString(16).padStart(16, '0'); // 64 бита
            const amount = jettonAmount.toString(16).padStart(32, '0'); // 128 бит
            
            // Упрощенный payload - используем только основные поля
            const payload = opcode + queryId;
            
            return payload;
        }

        // Обработчики событий TON Connect (только если tonConnectUI доступен)
        if (tonConnectUI) {
            console.log('Настраиваем обработчики TON Connect...');
            
            tonConnectUI.onStatusChange(async (wallet) => {
                try {
                    console.log('Статус кошелька изменился:', wallet);
                    if (wallet) {
                        walletAddress = wallet.account.address;
                        console.log('Кошелек подключен:', walletAddress);
                        walletAddressElement.textContent = `Адрес: ${walletAddress}`;
                        updateConnectionStatus(true);
                        await updateWalletInfo();
                    } else {
                        console.log('Кошелек отключен');
                        walletAddress = null;
                        updateConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Ошибка в onStatusChange:', error);
                    showError('Ошибка подключения', error.message);
                }
            });
            
            console.log('Обработчики TON Connect настроены');
        }

        // Обработчики кнопок (только если элементы найдены)
        if (refreshBalanceBtn) {
            refreshBalanceBtn.addEventListener('click', updateWalletInfo);
            console.log('Обработчик refreshBalance добавлен');
        }

        if (disconnectWalletBtn && tonConnectUI) {
            disconnectWalletBtn.addEventListener('click', async () => {
                try {
                    console.log('Отключаем кошелек...');
                    await tonConnectUI.disconnect();
                } catch (error) {
                    console.error('Ошибка отключения:', error);
                    showError('Ошибка отключения', error.message);
                }
            });
            console.log('Обработчик disconnect добавлен');
        }

        sendTransactionBtn.addEventListener('click', async () => {
            const amount = parseFloat(sendAmountInput.value);
            const recipientAddress = recipientAddressInput.value.trim();

            if (!amount || amount <= 0) {
                showError('Ошибка ввода', 'Введите корректную сумму');
                return;
            }

            if (!recipientAddress) {
                showError('Ошибка ввода', 'Введите адрес получателя');
                return;
            }

            if (parseFloat(ggcoinBalance) < amount) {
                showError('Недостаточно средств', `У вас только ${ggcoinBalance} GGCoin`);
                return;
            }

            if (!jettonWalletAddress) {
                showError('Ошибка', 'Не найден кошелек GGCoin');
                return;
            }

            try {
                sendTransactionBtn.classList.add('loading');
                
                // Проверяем наличие Jetton кошелька
                if (!jettonWalletAddress) {
                    showError('Ошибка', 'Сначала необходимо получить баланс GGCoin');
                    return;
                }
                
                const jettonAmount = Math.floor(amount * Math.pow(10, 9));
                
                // Создаем транзакцию без payload - иногда это работает лучше
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300, // 5 минут
                    messages: [
                        {
                            address: jettonWalletAddress,
                            amount: "50000000" // 0.05 TON для gas
                        }
                    ]
                };

                console.log('Отправляем транзакцию:', transaction);
                const result = await tonConnectUI.sendTransaction(transaction);
                
                if (result) {
                    showSuccess('Успех', 'Транзакция отправлена! Это была тестовая транзакция.');
                    sendAmountInput.value = '';
                    
                    // Обновить баланс через 5 секунд
                    setTimeout(updateWalletInfo, 5000);
                } else {
                    showError('Отмена', 'Транзакция была отменена');
                }
            } catch (error) {
                console.error('Ошибка транзакции:', error);
                
                // Более детальная обработка ошибок
                if (error.message.includes('USER_REJECTS_ERROR')) {
                    showError('Отмена', 'Транзакция отменена пользователем');
                } else if (error.message.includes('UNKNOWN_ERROR')) {
                    showError('Ошибка подключения', 'Проблема с подключением к кошельку. Попробуйте переподключиться.');
                } else if (error.message.includes('INSUFFICIENT_FUNDS')) {
                    showError('Недостаточно средств', 'Недостаточно TON для оплаты комиссии');
                } else {
                    showError('Ошибка транзакции', `Ошибка: ${error.message}`);
                }
            } finally {
                sendTransactionBtn.classList.remove('loading');
            }
        });

        // Обработчики Telegram WebApp (только если tg доступен)
        if (tg) {
            tg.onEvent('themeChanged', () => {
                try {
                    document.body.style.backgroundColor = tg.themeParams.bg_color;
                    document.body.style.color = tg.themeParams.text_color;
                    console.log('Тема изменена');
                } catch (error) {
                    console.error('Ошибка смены темы:', error);
                }
            });
        }

        // Финальная инициализация
        try {
            updateConnectionStatus(false);
            console.log('GGCoin WebApp успешно инициализирован');
            
            // Показываем статус готовности
            setTimeout(() => {
                networkStatus.textContent = 'Готов к подключению';
            }, 1000);
            
        } catch (error) {
            console.error('Ошибка финальной инициализации:', error);
            showError('Ошибка инициализации', error.message);
        }

        // Обработчик закрытия окна уведомлений
        errorWindow.addEventListener('click', () => {
            errorWindow.classList.remove('show');
        });

        // Периодическое обновление баланса (каждые 30 секунд)
        setInterval(() => {
            if (isConnected && walletAddress) {
                updateWalletInfo();
            }
        }, 30000);
        }

        // Запускаем инициализацию
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>