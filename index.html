<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Wallet WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .button {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .button:hover {
            opacity: 0.8;
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .wallet-info {
            margin-top: 20px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .balance-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .status {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Telegram Wallet WebApp</h1>
        
        <div id="status" class="status">Инициализация...</div>
        
        <div id="errors"></div>
        
        <div class="card">
            <button id="connectBtn" class="button" onclick="connectWallet()">
                Подключить кошелек
            </button>
            
            <button id="getBalanceBtn" class="button" onclick="getBalance()" disabled>
                Получить баланс
            </button>
            
            <button id="disconnectBtn" class="button" onclick="disconnectWallet()" disabled>
                Отключить кошелек
            </button>
        </div>
        
        <div id="walletInfo" class="wallet-info" style="display: none;">
            <div class="card">
                <h3>Информация о кошельке</h3>
                <div id="walletAddress"></div>
                <div id="walletBalance"></div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let wallet = null;
        let isConnected = false;
        
        // Инициализация WebApp
        function initApp() {
            try {
                tg.ready();
                tg.expand();
                
                // Проверяем поддержку кошелька
                if (!tg.WebApp) {
                    throw new Error('Telegram WebApp не поддерживается');
                }
                
                updateStatus('Готов к подключению');
                
                // Проверяем версию и доступность функций кошелька
                if (tg.version < "6.1") {
                    showError('Требуется версия Telegram 6.1 или выше для работы с кошельком');
                }
                
            } catch (error) {
                showError('Ошибка инициализации: ' + error.message);
            }
        }
        
        // Подключение к кошельку
        async function connectWallet() {
            try {
                updateStatus('Подключение к кошельку...');
                document.getElementById('connectBtn').disabled = true;
                
                // Проверяем поддержку кошелька в текущей версии
                if (!window.TelegramGameProxy && !tg.WebApp.requestContact) {
                    throw new Error('Кошелек не поддерживается в данной версии Telegram');
                }
                
                // Попытка подключения к TON кошельку
                if (typeof window.ton !== 'undefined') {
                    // Если есть TON Connect
                    await connectTonWallet();
                } else if (tg.WebApp.requestWriteAccess) {
                    // Альтернативный способ через WebApp API
                    await connectTelegramWallet();
                } else {
                    throw new Error('Кошелек недоступен. Убедитесь что вы используете последнюю версию Telegram');
                }
                
            } catch (error) {
                showError('Ошибка подключения кошелька: ' + error.message);
                document.getElementById('connectBtn').disabled = false;
            }
        }
        
        // Подключение через TON Connect
        async function connectTonWallet() {
            try {
                // Симуляция подключения к TON кошельку
                const tonConnectUI = new TONConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json'
                });
                
                const connectedWallet = await tonConnectUI.connectWallet();
                
                if (connectedWallet) {
                    wallet = connectedWallet;
                    isConnected = true;
                    
                    showSuccess('Кошелек успешно подключен!');
                    updateStatus('Кошелек подключен');
                    
                    document.getElementById('getBalanceBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showWalletInfo(wallet.account.address);
                }
                
            } catch (error) {
                throw new Error('TON Connect недоступен: ' + error.message);
            }
        }
        
        // Альтернативное подключение через Telegram WebApp
        async function connectTelegramWallet() {
            try {
                // Запрос доступа к кошельку через WebApp API
                const result = await new Promise((resolve, reject) => {
                    tg.WebApp.requestWriteAccess((granted) => {
                        if (granted) {
                            resolve(true);
                        } else {
                            reject(new Error('Доступ к кошельку не предоставлен'));
                        }
                    });
                });
                
                if (result) {
                    // Симуляция подключенного кошелька
                    wallet = {
                        address: 'EQD...' + Math.random().toString(36).substring(7),
                        network: 'mainnet'
                    };
                    isConnected = true;
                    
                    showSuccess('Кошелек успешно подключен через Telegram!');
                    updateStatus('Кошелек подключен');
                    
                    document.getElementById('getBalanceBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showWalletInfo(wallet.address);
                }
                
            } catch (error) {
                throw new Error('Telegram Wallet недоступен: ' + error.message);
            }
        }
        
        // Получение баланса
        async function getBalance() {
            try {
                if (!isConnected || !wallet) {
                    throw new Error('Кошелек не подключен');
                }
                
                updateStatus('Получение баланса...');
                document.getElementById('getBalanceBtn').disabled = true;
                
                // Симуляция получения баланса
                const balanceData = await simulateGetBalance();
                
                showBalanceInfo(balanceData);
                showSuccess('Баланс успешно получен!');
                updateStatus('Баланс обновлен');
                
                document.getElementById('getBalanceBtn').disabled = false;
                
            } catch (error) {
                showError('Ошибка получения баланса: ' + error.message);
                document.getElementById('getBalanceBtn').disabled = false;
            }
        }
        
        // Симуляция получения баланса (замените на реальный API)
        async function simulateGetBalance() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        TON: (Math.random() * 100).toFixed(2),
                        USDT: (Math.random() * 1000).toFixed(2),
                        BTC: (Math.random() * 0.01).toFixed(4)
                    });
                }, 1500);
            });
        }
        
        // Отключение кошелька
        function disconnectWallet() {
            try {
                wallet = null;
                isConnected = false;
                
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('getBalanceBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = true;
                
                document.getElementById('walletInfo').style.display = 'none';
                
                showSuccess('Кошелек отключен');
                updateStatus('Кошелек отключен');
                
            } catch (error) {
                showError('Ошибка отключения: ' + error.message);
            }
        }
        
        // Отображение информации о кошельке
        function showWalletInfo(address) {
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');
            
            walletAddress.innerHTML = `<strong>Адрес:</strong> ${address.substring(0, 10)}...${address.substring(address.length - 10)}`;
            walletInfo.style.display = 'block';
        }
        
        // Отображение баланса
        function showBalanceInfo(balanceData) {
            const walletBalance = document.getElementById('walletBalance');
            let balanceHTML = '<h4>Баланс:</h4>';
            
            for (const [currency, amount] of Object.entries(balanceData)) {
                balanceHTML += `
                    <div class="balance-item">
                        <span>${currency}</span>
                        <span>${amount}</span>
                    </div>
                `;
            }
            
            walletBalance.innerHTML = balanceHTML;
        }
        
        // Отображение ошибок
        function showError(message) {
            const errorsDiv = document.getElementById('errors');
            errorsDiv.innerHTML = `<div class="error"><strong>Ошибка:</strong> ${message}</div>`;
            console.error('Wallet Error:', message);
        }
        
        // Отображение успешных операций
        function showSuccess(message) {
            const errorsDiv = document.getElementById('errors');
            errorsDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                errorsDiv.innerHTML = '';
            }, 3000);
        }
        
        // Обновление статуса
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Обработчики событий WebApp
        tg.onEvent('themeChanged', function() {
            console.log('Theme changed');
        });
        
        tg.onEvent('viewportChanged', function() {
            console.log('Viewport changed');
        });
        
        // Инициализация при загрузке
        window.addEventListener('load', initApp);
        
        // Обработка ошибок
        window.addEventListener('error', function(event) {
            showError('Глобальная ошибка: ' + event.error.message);
        });
        
        // Обработка необработанных промисов
        window.addEventListener('unhandledrejection', function(event) {
            showError('Необработанная ошибка промиса: ' + event.reason);
        });
    </script>
</body>
</html>