<!DOCTYPE html>
<html>
<head>
    <meta name="telegram:verify" content="VERIFICATION_CODE_OT_BOTFATHER">
    <link rel="manifest" href="/app-manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000022">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; touch-action: none }
        body { background: #000022 }
    </style>
</head>
<body>
    <div id="game"></div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const isTelegram = /Telegram/.test(navigator.userAgent);
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.show();

        class MainScene extends Phaser.Scene {
            constructor() {
                super();
                this.coins = [];
                this.rotSpeed = isTelegram ? 0.005 : 0.01;
                this.scaleFactor = 0.001;
                this.isDragging = false;
            }

            preload() {
                this.load.setBaseURL('https://ikelbik.github.io/tgtest');
                this.load.image('bg', 'assets/wtf.png');
                this.load.obj('coin', 'assets/fantom.obj');
                this.load.image('texture', 'assets/coin_txt.png');
            }

            create() {
                if (isTelegram && window.TelegramWebViewProxy) {
                    TelegramWebViewProxy.onEvent('back_button', () => this.scene.stop());
                }

                const { centerX, centerY } = this.cameras.main;
                this.add.image(centerX, centerY, 'bg');
                
                // Создаем стопку из 7 монет
                const stackHeight = 7;
                const zSpacing = 0.25;
                const yOffset = 0.07;
                
                for (let i = 0; i < stackHeight; i++) {
                    const coin = this.add.mesh(
                        centerX,
                        centerY - i * yOffset * 10,
                        'texture'
                    );
                    
                    coin.addVerticesFromObj('coin', 0.1)
                        .panZ(5 + i * zSpacing)
                        .setScale(1)
                        .modelRotation.y += Phaser.Math.FloatBetween(0, 1.28);
                    
                    this.coins.push(coin);
                }

                // Настройка управления
                this.input.on('pointerdown', () => this.isDragging = true);
                this.input.on('pointerup', () => this.isDragging = false);
                this.input.on('pointermove', (ptr) => {
                    if (this.isDragging && ptr.isDown) {
                        this.coins.forEach(coin => {
                            coin.modelRotation.y += ptr.velocity.x * this.rotSpeed;
                            coin.modelRotation.x += ptr.velocity.y * this.rotSpeed;
                        });
                    }
                });
            }

            update(time) {
                // Плавная анимация стопки
                this.coins.forEach((coin, i) => {
                    coin.modelRotation.y += this.rotSpeed * (1 + i * 0.05);
                    coin.modelRotation.x = Math.sin(time * 0.001 + i) * 0.05;
                    coin.modelPosition.z = 5 + Math.cos(time * 0.001 + i) * 0.1;
                });
            }
        }

        const config = {
            type: Phaser.WEBGL,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game',
            scene: MainScene,
            scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH },
            input: { activePointers: 2 },
            fps: { target: 60, smoothStep: true },
            render: { antialiasGL: false }
        };

        const game = new Phaser.Game(config);
        window.addEventListener('resize', () => game.scale.resize(window.innerWidth, window.innerHeight));
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>