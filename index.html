<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Space WebApp - GGCoin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/@ton/ton@latest/dist/ton.min.js"></script>
    <style>
        /* ... (ваши стили остаются без изменений) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (ваша HTML структура остается без изменений) ... -->
    </div>

    <div class="error-window" id="error-window">
        <div class="error-title">Ошибка</div>
        <div class="error-message" id="error-message"></div>
    </div>

    <script>
        // Проверка загрузки всех необходимых библиотек
        function checkLibrariesLoaded() {
            if (!window.Telegram || !window.TON_CONNECT_UI || !window.TON) {
                return false;
            }
            return true;
        }

        // Основная функция инициализации
        async function initApp() {
            try {
                // Проверяем загрузку библиотек
                if (!checkLibrariesLoaded()) {
                    throw new Error('Библиотеки не загружены. Обновите страницу.');
                }

                // Инициализация Telegram WebApp
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                // Конфигурация TON Connect
                const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect-button'
                });

                // Константы для GGCoin
                const GGCOIN_CONTRACT_ADDRESS = '0:7f82a882da388deecaa53806c44c375f697a09fd86d93e9c0e1832749b222b0b';
                const GGCOIN_DECIMALS = 9;

                // Элементы DOM
                const walletInfo = document.getElementById('wallet-info');
                const walletAddressElement = document.getElementById('wallet-address');
                const balancesSection = document.getElementById('balances-section');
                const balancesList = document.getElementById('balances-list');
                const actionsSection = document.getElementById('actions-section');
                const refreshBalanceBtn = document.getElementById('refresh-balance');
                const disconnectWalletBtn = document.getElementById('disconnect-wallet');
                const sendTransactionBtn = document.getElementById('send-transaction');
                const sendAmountInput = document.getElementById('send-amount');
                const recipientAddressInput = document.getElementById('recipient-address');
                const statusIndicator = document.getElementById('status-indicator');
                const networkStatus = document.getElementById('network-status');
                const transactionsList = document.getElementById('transactions-list');
                const errorWindow = document.getElementById('error-window');
                const errorMessage = document.getElementById('error-message');

                // Переменные состояния
                let walletAddress = null;
                let isConnected = false;
                let transactions = [];
                let ggcoinBalance = 0;

                // Функция отображения ошибок/уведомлений
                function showMessage(title, message, isSuccess = false) {
                    try {
                        console.log(`${title}: ${message}`);
                        const errorWindow = document.getElementById('error-window');
                        const errorTitle = errorWindow.querySelector('.error-title');
                        const errorMsg = errorWindow.querySelector('.error-message');
                        
                        errorTitle.textContent = title;
                        errorMsg.textContent = message;
                        
                        if (isSuccess) {
                            errorWindow.classList.add('success');
                        } else {
                            errorWindow.classList.remove('success');
                        }
                        
                        errorWindow.classList.add('show');
                        
                        // Автоматически скрыть через 5 секунд
                        setTimeout(() => {
                            errorWindow.classList.remove('show');
                        }, 5000);
                    } catch (e) {
                        console.error('Ошибка при отображении сообщения:', e);
                    }
                }

                // Функция отображения ошибок
                function showError(title, message) {
                    showMessage(title, message, false);
                }

                // Функция отображения успешных уведомлений
                function showSuccess(title, message) {
                    showMessage(title, message, true);
                }

                // Функция обновления статуса подключения
                function updateConnectionStatus(connected) {
                    isConnected = connected;
                    if (connected) {
                        statusIndicator.className = 'status-indicator status-connected';
                        networkStatus.textContent = 'Подключено к TON';
                        walletInfo.style.display = 'block';
                        balancesSection.style.display = 'block';
                        actionsSection.style.display = 'block';
                    } else {
                        statusIndicator.className = 'status-indicator status-disconnected';
                        networkStatus.textContent = 'Не подключено';
                        walletInfo.style.display = 'none';
                        balancesSection.style.display = 'none';
                        actionsSection.style.display = 'none';
                    }
                }

                // Функция получения баланса GGCoin
                async function getGGCoinBalance(address) {
                    try {
                        const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons`);
                        
                        if (!response.ok) {
                            throw new Error(`Ошибка сети: ${response.status} ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.balances && data.balances.length > 0) {
                            const ggcoinBalance = data.balances.find(balance => 
                                balance.jetton.address === GGCOIN_CONTRACT_ADDRESS
                            );
                            
                            if (ggcoinBalance) {
                                const balance = parseFloat(ggcoinBalance.balance) / Math.pow(10, GGCOIN_DECIMALS);
                                return {
                                    symbol: 'GGCoin',
                                    name: 'GoblinGotts Coin',
                                    balance: balance.toFixed(4),
                                    address: GGCOIN_CONTRACT_ADDRESS,
                                    image: ggcoinBalance.jetton.image,
                                    wallet_address: ggcoinBalance.wallet_address.address
                                };
                            }
                        }
                        
                        return {
                            symbol: 'GGCoin',
                            name: 'GoblinGotts Coin',
                            balance: '0.0000',
                            address: GGCOIN_CONTRACT_ADDRESS,
                            wallet_address: null
                        };
                    } catch (error) {
                        showError('Ошибка баланса', error.message);
                        return {
                            symbol: 'GGCoin',
                            name: 'GoblinGotts Coin',
                            balance: '0.0000',
                            address: GGCOIN_CONTRACT_ADDRESS,
                            wallet_address: null
                        };
                    }
                }

                // Функция отображения баланса
                function displayBalance(tokenInfo) {
                    balancesList.innerHTML = '';
                    
                    const balanceItem = document.createElement('div');
                    balanceItem.className = 'balance-item';
                    
                    balanceItem.innerHTML = `
                        <div class="token-info">
                            ${tokenInfo.image ? `<img src="${tokenInfo.image}" alt="GGCoin" class="ggcoin-logo">` : ''}
                            <div>
                                <div class="token-symbol">${tokenInfo.symbol}</div>
                                <div class="token-name">${tokenInfo.name}</div>
                            </div>
                        </div>
                        <div class="balance-amount">${tokenInfo.balance}</div>
                    `;
                    
                    balancesList.appendChild(balanceItem);
                    
                    // Сохраняем баланс для отправки
                    ggcoinBalance = parseFloat(tokenInfo.balance);
                }

                // Функция получения транзакций
                async function getTransactions(address) {
                    try {
                        const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons/${GGCOIN_CONTRACT_ADDRESS}/history?limit=10`);
                        
                        if (!response.ok) {
                            throw new Error(`Ошибка сети: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.events) {
                            return data.events;
                        } else {
                            return [];
                        }
                    } catch (error) {
                        console.log('Ошибка получения транзакций:', error);
                        return [];
                    }
                }

                // Функция отображения транзакций
                function displayTransactions(txs) {
                    transactionsList.innerHTML = '';
                    
                    if (txs.length === 0) {
                        transactionsList.innerHTML = '<div style="text-align: center; color: #999;">Нет транзакций GGCoin</div>';
                        return;
                    }

                    txs.forEach(tx => {
                        const txElement = document.createElement('div');
                        txElement.className = 'transaction-item';
                        
                        let amount = '0.00';
                        let direction = 'unknown';
                        
                        if (tx.actions && tx.actions.length > 0) {
                            const action = tx.actions[0];
                            if (action.JettonTransfer) {
                                amount = (parseFloat(action.JettonTransfer.amount) / Math.pow(10, GGCOIN_DECIMALS)).toFixed(4);
                                direction = action.JettonTransfer.sender?.address === walletAddress ? 'out' : 'in';
                            }
                        }
                        
                        txElement.innerHTML = `
                            <div class="transaction-amount">${direction === 'out' ? '-' : '+'}${amount} GGCoin</div>
                            <div class="transaction-hash">Hash: ${tx.event_id}</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${new Date(tx.timestamp * 1000).toLocaleString()}
                            </div>
                        `;
                        
                        transactionsList.appendChild(txElement);
                    });
                }

                // Функция обновления информации о кошельке
                async function updateWalletInfo() {
                    if (!walletAddress) return;
                    
                    try {
                        refreshBalanceBtn.classList.add('loading');
                        balancesList.innerHTML = '<div class="balance-loading">Загрузка баланса GGCoin...</div>';
                        
                        const balance = await getGGCoinBalance(walletAddress);
                        displayBalance(balance);
                        
                        const txs = await getTransactions(walletAddress);
                        displayTransactions(txs);
                        
                    } catch (error) {
                        showError('Ошибка обновления', error.message);
                    } finally {
                        refreshBalanceBtn.classList.remove('loading');
                    }
                }

                // Функция создания Jetton transfer транзакции
                async function createJettonTransferMessage(recipientAddress, amount, queryId = 0) {
                    // Проверка загрузки TON
                    if (!window.TON) {
                        throw new Error('TON библиотека не загружена');
                    }
                    
                    const transferBody = new TON.Cell();
                    
                    // Jetton transfer opcode
                    transferBody.bits.writeUint(0x0f8a7ea5, 32);
                    // query_id
                    transferBody.bits.writeUint(queryId, 64);
                    // amount
                    transferBody.bits.writeCoins(amount);
                    
                    // Адрес получателя
                    const recipientCell = new TON.Cell();
                    recipientCell.bits.writeAddress(new TON.Address(recipientAddress));
                    transferBody.refs.push(recipientCell);
                    
                    // Адрес для ответа
                    const responseCell = new TON.Cell();
                    responseCell.bits.writeAddress(new TON.Address(walletAddress));
                    transferBody.refs.push(responseCell);
                    
                    // Пустая ячейка для custom_payload
                    transferBody.refs.push(new TON.Cell());
                    
                    // Forward amount
                    transferBody.bits.writeCoins(0);
                    
                    // Пустая ячейка для forward_payload
                    transferBody.refs.push(new TON.Cell());
                    
                    // Сериализуем в BOC и конвертируем в HEX
                    const bocBytes = await transferBody.toBoc({ idx: false });
                    return Array.from(bocBytes).map(b => b.toString(16).padStart(2, '0')).join('');
                }

                // Обработчики событий TON Connect
                tonConnectUI.onStatusChange(async (wallet) => {
                    try {
                        if (wallet) {
                            walletAddress = wallet.account.address;
                            walletAddressElement.textContent = `Адрес: ${walletAddress}`;
                            updateConnectionStatus(true);
                            await updateWalletInfo();
                        } else {
                            walletAddress = null;
                            updateConnectionStatus(false);
                        }
                    } catch (error) {
                        showError('Ошибка подключения', error.message);
                    }
                });

                // Обработчики кнопок
                refreshBalanceBtn.addEventListener('click', updateWalletInfo);

                disconnectWalletBtn.addEventListener('click', async () => {
                    try {
                        await tonConnectUI.disconnect();
                    } catch (error) {
                        showError('Ошибка отключения', error.message);
                    }
                });

                sendTransactionBtn.addEventListener('click', async () => {
                    // Проверка подключения кошелька
                    if (!tonConnectUI.connected) {
                        showError('Кошелек отключен', 'Подключите кошелек перед отправкой');
                        return;
                    }
                    
                    const amount = parseFloat(sendAmountInput.value);
                    const recipientAddress = recipientAddressInput.value.trim();

                    if (!amount || amount <= 0 || isNaN(amount)) {
                        showError('Ошибка ввода', 'Введите корректную сумму');
                        return;
                    }

                    if (!recipientAddress) {
                        showError('Ошибка ввода', 'Введите адрес получателя');
                        return;
                    }

                    if (amount > ggcoinBalance) {
                        showError('Недостаточно средств', `У вас только ${ggcoinBalance.toFixed(4)} GGCoin`);
                        return;
                    }

                    try {
                        sendTransactionBtn.classList.add('loading');
                        sendTransactionBtn.disabled = true;
                        
                        // Получаем информацию о кошельке пользователя для GGCoin
                        const balanceInfo = await getGGCoinBalance(walletAddress);
                        
                        if (!balanceInfo.wallet_address) {
                            throw new Error('Не удалось найти кошелек GGCoin');
                        }

                        // Создаем транзакцию для перевода Jetton
                        const amountNano = Math.floor(amount * Math.pow(10, GGCOIN_DECIMALS));
                        const queryId = Math.floor(Date.now() / 1000);
                        
                        const payload = await createJettonTransferMessage(
                            recipientAddress,
                            amountNano,
                            queryId
                        );
                        
                        const transaction = {
                            validUntil: Math.floor(Date.now() / 1000) + 300, // 5 минут
                            messages: [
                                {
                                    address: balanceInfo.wallet_address,
                                    amount: "100000000", // 0.1 TON для газа
                                    payload: payload
                                }
                            ]
                        };

                        const result = await tonConnectUI.sendTransaction(transaction);
                        
                        if (result.boc) {
                            showSuccess('Успех!', `Транзакция отправлена!`);
                            sendAmountInput.value = '';
                            
                            // Обновить баланс через 15 секунд
                            setTimeout(updateWalletInfo, 15000);
                        } else {
                            throw new Error('Не удалось отправить транзакцию');
                        }
                    } catch (error) {
                        console.error('Детали ошибки:', error);
                        
                        // Специфичные ошибки TON
                        if (error.message.includes('Connection') || error.message.includes('Network')) {
                            showError('Ошибка сети', 'Проверьте интернет-соединение и попробуйте снова');
                        } else if (error.message.includes('insufficient') || error.message.includes('balance')) {
                            showError('Недостаточно TON', 'Пополните баланс TON для оплаты комиссии');
                        } else if (error.message.includes('rejected')) {
                            showError('Отменено', 'Вы отменили транзакцию');
                        } else {
                            showError('Ошибка транзакции', error.message || 'Неизвестная ошибка при отправке');
                        }
                    } finally {
                        sendTransactionBtn.classList.remove('loading');
                        sendTransactionBtn.disabled = false;
                    }
                });

                // Обработчики Telegram WebApp
                tg.onEvent('themeChanged', () => {
                    try {
                        if (tg && tg.themeParams) {
                            document.body.style.backgroundColor = tg.themeParams.bg_color;
                            document.body.style.color = tg.themeParams.text_color;
                        }
                    } catch (error) {
                        console.error('Ошибка темы:', error);
                    }
                });

                // Инициализация статуса
                updateConnectionStatus(false);
                console.log('TON Connect WebApp для GGCoin инициализирован');

            } catch (error) {
                console.error('Критическая ошибка инициализации:', error);
                showError('Ошибка запуска', 'Не удалось инициализировать приложение. Попробуйте перезагрузить страницу.');
            }
        }

        // Запуск приложения после полной загрузки страницы
        window.addEventListener('DOMContentLoaded', () => {
            // Проверка готовности библиотек
            const checkInterval = setInterval(() => {
                if (checkLibrariesLoaded()) {
                    clearInterval(checkInterval);
                    initApp();
                }
            }, 100);
        });

        // Обработчик закрытия окна уведомлений
        document.getElementById('error-window')?.addEventListener('click', () => {
            document.getElementById('error-window')?.classList.remove('show');
        });
    </script>
</body>
</html>